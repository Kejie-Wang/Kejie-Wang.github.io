<!doctype html>



  


<html class="theme-next pisces use-motion" lang="en">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>






<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta property="og:type" content="website">
<meta property="og:title" content="Kejie Wang">
<meta property="og:url" content="www.wangkejie.me/index.html">
<meta property="og:site_name" content="Kejie Wang">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Kejie Wang">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="www.wangkejie.me/"/>





  <title>Kejie Wang</title><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
<!-- hexo-inject:begin --><!-- hexo-inject:end --><script>
  window.fbAsyncInit = function() {
    FB.init({
      appId      : '',
      xfbml      : true,
      version    : 'v2.6'
    });
  };

  (function(d, s, id){
     var js, fjs = d.getElementsByTagName(s)[0];
     if (d.getElementById(id)) {return;}
     js = d.createElement(s); js.id = id;
     js.src = "//connect.facebook.net/en/sdk.js";
     fjs.parentNode.insertBefore(js, fjs);
   }(document, 'script', 'facebook-jssdk'));
</script>






  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?45f7bfb4a5cde39cf2d10105a0e916b2";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>











  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Kejie Wang</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="www.wangkejie.me/2017/08/03/charset-and-character-encoding/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kejie Wang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kejie Wang">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/08/03/charset-and-character-encoding/" itemprop="url">Charset and Character Encoding</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-08-03T21:25:32+08:00">
                2017-08-03
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/08/03/charset-and-character-encoding/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count fb-comments-count" data-href="www.wangkejie.me/2017/08/03/charset-and-character-encoding/" itemprop="commentCount">0</span> comments
                </a>
              </span>
            
          

          
          
             <span id="/2017/08/03/charset-and-character-encoding/" class="leancloud_visitors" data-flag-title="Charset and Character Encoding">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Visitors </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Opening a document downloaded from Internet usually displays garbled code, most of which are caused by  opening with an incorrect encoding. You may hear many encoding character sets, such as ASCII, Unicode, UTF-8, UTF-16 and so on. Most of us will be confused by these encoding and this article will introduce the details of some encodings and their differences between them.</p>
<p>&lt;!--more--&gt;</p>
<h2>ASCII</h2>
<p>ASCII  abbreviated <strong>A</strong>merican <strong>S</strong>tandard <strong>C</strong>ode for <strong>I</strong>nformation <strong>I</strong>nterchange is a character encoding standard.</p>
<p><img src="/images/character-encoding/asciifull.gif" alt="asciifull"></p>
<p>It uses 7 bits to devote a character and thus there are 128 (2^7) characters from 0x00 to 0x7F. The standard ASCII contains only the lowercase letters a-z, uppercase letters A-Z,  numbers 0-9, basic punctuations and some control codes.</p>
<h2>GB2312, GBK</h2>
<p>Ascii can meet most of demands when the computer only widely used in the America and the some western countries. But how to represent the Chinese characters became a big problem when Chinese want to use computer too. And thus some encoding stardard methods were developed. GB2312 is backward compatible with ASCII and it uses one byte (8 bits with leading zero) is same as ASCII but two bytes greater than 127 (each byte with leading 1) to represent Chinese characters. It totally contains 7445 characters including 6763 Chinese characters and 682 other characters. Though GB2312 can meet 99.75% usages of Chinese characters, it doesn't support some uncommon characters and GBK was developed for supporting more characters.</p>
<h2>Unicode</h2>
<p>With the populariry of computer in the world, each country developed a individual encoding method for supporting their language like gb2312. But there are not compatible and it can be a big problem when it need exchange information on Internet.</p>
<p>Therefore, an character set including all languages is need. Then Unciode came which assigns each character a unique number called <strong>code point</strong>. The latest version of Unicode (Unicode 10.0) contains 136,755 characters.</p>
<p>Unicode can be implemented by different character encodings such as UTF-8, UTF-16, UTF-32, UCS-2 and so on.</p>
<h3>UTF-8</h3>
<p>UTF-8 is a variable-length character encoding capable of encoding all possible Unicode code points. It was designed to be backward compatible with ASCII and to avoid the complications of endiness (Big-end or Little-end).</p>
<table>
<thead>
<tr>
<th style="text-align:center">Number of bytes</th>
<th style="text-align:center">Code points range</th>
<th style="text-align:center">Bytes representation</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center">U+0000 ~ U+007F</td>
<td style="text-align:center">0XXXXXX</td>
</tr>
<tr>
<td style="text-align:center">2</td>
<td style="text-align:center">U+0080 ~ U+07FF</td>
<td style="text-align:center">110XXXXX 10XXXXXX</td>
</tr>
<tr>
<td style="text-align:center">3</td>
<td style="text-align:center">U+0800 ~ U+FFFF</td>
<td style="text-align:center">1110XXXX 10XXXXXX 10XXXXXX</td>
</tr>
<tr>
<td style="text-align:center">4</td>
<td style="text-align:center">U+10000 ~ U+10FFF</td>
<td style="text-align:center">11110XXX 10XXXXXX 10XXXXXX 10XXXXXX</td>
</tr>
</tbody>
</table>
<h3>UCS-2</h3>
<p>UCS-2 simply use two bytes for each character and thus it can only encode 65536 code points, the so-called Basic Multilingual Plane (BMP). And thus many Unicode characters are beyond the reach of UCS-2.</p>
<h3>UTF-16</h3>
<p>UTF=16 extends UCS-2 by using the same 16 bits as UCS-2 and use 32 bits for the others planes. Since UTF-16 use 2 bytes as an unit and thus the byte order matters. To recoginize the byte order of code unit, UTF-16 allows a <strong>Byte Order Mark (BOM)</strong> to precede the first actual coded value. The BOM with code point value U+FEFF is an invisible zero-width non-breaking space character. The BOM in UTF-16BE (UTF-16 Big Endian) is 0xFEFF but 0xFFFE in UTF-16LE (UTF-16 Little Endian). Older Windows NT system use UCS-2 and UTF-16 is used for text in OS API in Microsoft Windows 2000/XP/2003/7/8.</p>
<h3>UTF-32</h3>
<p>UTF-32 is a fixed length encoding which uses 4 bytes to represente a character. The main advantage of UTF-82 is that the Unicode character is indexable since it is all 4 bytes aligned but it is NOT space efficient since characters beyond BMP are rarely used. And same as UTF-16, UTF-32 do NOT have endianness defined.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="www.wangkejie.me/2017/07/05/vim-ycm-install/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kejie Wang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kejie Wang">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/05/vim-ycm-install/" itemprop="url">A vim autocomplete plugin - YouCompleteMe installation guide</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-07-05T13:14:32+08:00">
                2017-07-05
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/07/05/vim-ycm-install/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count fb-comments-count" data-href="www.wangkejie.me/2017/07/05/vim-ycm-install/" itemprop="commentCount">0</span> comments
                </a>
              </span>
            
          

          
          
             <span id="/2017/07/05/vim-ycm-install/" class="leancloud_visitors" data-flag-title="A vim autocomplete plugin - YouCompleteMe installation guide">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Visitors </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="http://valloric.github.io/YouCompleteMe/#intro" target="_blank" rel="external">YouCompleteMe</a> (YCM) is a fast, powerful code completion engine for vim. But unlike the other vim plugins which are easy to install, YCM needs to complier to install. This article will briefly introduce the full installation guide of YCM.</p>
<p>&lt;!-- more --&gt;</p>
<h2>Prerequisites</h2>
<p>Before you install the ycm, make sure the follow packages have been installed:</p>
<h3>Vim</h3>
<p>Ensure that your version of Vim is at least <strong>7.4.1578</strong> and that is has support for Python 2 or Python 3 scripting. Enter <code>vim -version</code> in the terminal to check the vim version. Typpe<code>vim --version | grep python</code> to check the Python support. If a plus(+) not a minus (-) before Python2 or Python3, then the vim support Python. If not, follow the guide to install vim8.0 with Python support.</p>
<ul>
<li>
<p>Download the <a href="https://github.com/vim/vim" target="_blank" rel="external">vim</a> source</p>
<p><code>git clone https://github.com/vim/vim.git</code></p>
</li>
<li>
<p>Install some dependencies</p>
<p><code>sudo apt-get install libncurses5-dev python2.7-dev</code></p>
</li>
<li>
<p>Configure and Install</p>
<p><code>cd vim &amp;&amp; ./configure --enable-pythoninterp --with-python-config-dir=/usr/lib/python2.7/config-x86_64-linux-gnu</code></p>
<p><code>make &amp;&amp; make install</code></p>
</li>
</ul>
<h3>Vundle</h3>
<p>Vundle is a vim plugin manager and follow the installion guide in <a href="https://github.com/VundleVim/Vundle.vim" target="_blank" rel="external">Vundle</a> to install.</p>
<h2>Install YCM</h2>
<p>Install YCM with Vundle is a recommended way. WithVundle, adding a <code>Plugin 'Valloric/YouCompleteMe'</code> line to your <a href="http://vimhelp.appspot.com/starting.txt.html#vimrc" target="_blank" rel="external">vimrc</a> and execute <code>PluginInstall</code> in vim.</p>
<p>And the enter the YCM repository directory and run follow command to fetch the YCM's dependencies.</p>
<p><code>git submodule update --init --recursive</code></p>
<h2>Install libclang</h2>
<p>The semantic completion for C-family languages need libclang and you can jump this step if you do NOT need it.</p>
<h3>Using the pre-built binary</h3>
<p>Download the pre-built binary from <a href="http://releases.llvm.org/download.html" target="_blank" rel="external">llvm</a> for your corresponding system. But sometimes this can be failed for some different dependencies version and you can build from the source.</p>
<h3>Compile from source</h3>
<ul>
<li>
<p>Download the source code from <a href="http://releases.llvm.org/download.html" target="_blank" rel="external">llvm</a></p>
<p>Download the llvm, clang, compiler-rt and clang-tools-extra packages and extract the source code.</p>
<p><code>wget http://releases.llvm.org/4.0.1/llvm-4.0.1.src.tar.xz</code></p>
<p><code>wget http://releases.llvm.org/4.0.1/cfe-4.0.1.src.tar.xz</code></p>
<p><code>wget http://releases.llvm.org/4.0.1/compiler-rt-4.0.1.src.tar.xz</code></p>
<p><code>wget http://releases.llvm.org/4.0.1/clang-tools-extra-4.0.1.src.tar.xz</code></p>
</li>
<li>
<p>Move the source code</p>
<p><code>mv llvm-4.0.1.src llvm</code></p>
<p><code>mv cfe-4.0.1.src llvm/tools/clang</code></p>
<p><code>mv clang-tools-extra-4.0.1.src llvm/tools/clang/tools/extra</code></p>
<p><code>mv compiler-rt-4.0.1.src llvm/projects/compiler-rt</code></p>
</li>
<li>
<p>Build the LLVM and clang</p>
<p><code>mkdir build &amp;&amp; cd build</code></p>
<p><code>cmake -G &quot;Unix Makefiles&quot; ../llvm</code></p>
</li>
</ul>
<h2>Compile the <em>ycm_core</em></h2>
<p>Before you compile the ycm_core, make sure that the <a href="https://cmake.org/download/" target="_blank" rel="external">cmake</a> has been installed.</p>
<ul>
<li>
<p>Create the build directory</p>
<p><code>mkdir ~/ycm_build &amp;&amp; cd ~/ycm_build</code></p>
</li>
<li>
<p>Generate the makefiles</p>
<ul>
<li>
<p>No semantic support</p>
<p><code>cmake -G &quot;Unix Makefiles&quot; . ~/.vim/bundle/YouCompleteMe/third_party/ycmd/cpp</code></p>
</li>
<li>
<p>Semantic support</p>
<p><code>cmake -G &quot;Unix Makefiles&quot; -DPATH_TO_LLVM_ROOT=llvm_root_dir . ~/.vim/bundle/YouCompleteMe/third_party/ycmd/cpp</code></p>
<p>Where <strong><em>llvm_root_dir</em></strong> is the root dir where you extract the downloaded binary distribution.</p>
</li>
</ul>
</li>
<li>
<p>Compile</p>
<p><code>cmake --build . --target ycm_core --config Release</code></p>
</li>
</ul>
<p>Now you can find the <strong><em>ycm_core</em></strong> in <strong><em>~/.vim/bundle/YouCompleteMe/third_party/ycmd/ycm_core.so</em></strong></p>
<h2>Test Installation</h2>
<p>Open a test file and enter some words to check whether it works.</p>
<p><img src="/images/vim-ycm-install/test.png" alt=""></p>
<h2>Issues</h2>
<h3>GLIBC Error</h3>
<p><strong>I use the python from anaconda2 and there is an problem when I finish the installation.</strong></p>
<p><strong><code>lib/libstdc++.so.6: version 'GLIBCXX_3.4.20' not found</code></strong></p>
<p>Install the libgcc package to solve</p>
<p><code>conda install libgcc</code></p>
<h3>Python version</h3>
<p><strong>I compile the vim using python in anaconda but ycm is unavaiable. The issue is<code>YouCompleteMe unavailable: dlopen(/Users/jack/anaconda2/lib/python2.7/lib-dynload/_io.so, 2)</code></strong></p>
<p>Compile the vim using system python.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="www.wangkejie.me/2017/06/12/shadowsocks/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kejie Wang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kejie Wang">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/06/12/shadowsocks/" itemprop="url">Shadowsocks服务器搭建以及不同终端的客户端配置</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-06-12T22:28:58+08:00">
                2017-06-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/shadowsocks/" itemprop="url" rel="index">
                    <span itemprop="name">shadowsocks</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/06/12/shadowsocks/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count fb-comments-count" data-href="www.wangkejie.me/2017/06/12/shadowsocks/" itemprop="commentCount">0</span> comments
                </a>
              </span>
            
          

          
          
             <span id="/2017/06/12/shadowsocks/" class="leancloud_visitors" data-flag-title="Shadowsocks服务器搭建以及不同终端的客户端配置">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Visitors </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>众所周知，中国建立了强大的防火长城已禁止网民访问敏感网站，为此衍生出了大批的翻墙软件，诸如：Shadowsocks, GoAgent, Lantern......本文主要讲介绍目前使用最多的Shadowsocks在服务器端的安装以及在不同终端的客户端的配置
&lt;!-- more --&gt;</p>
<h1>Shadowsocks服务器搭建</h1>
<h2>vps获取</h2>
<p>对于翻墙的前提就是需要一台在国外的服务器。对于专业的用户可以自行购买vps进行配置，目前作者采用的是<a href="https://bwh1.net/" target="_blank" rel="external"><strong><em>搬瓦工</em></strong></a>的vps，这个价格相对比较便宜，有和中国电信直连的线路，而且支持支付宝付款。对于购买搬瓦工的用户，推荐购买最新推出的KVM架构的服务器，这样可以安装锐速进行加速。另一个作者使用过的为<a href="https://www.vultr.com/" target="_blank" rel="external"><strong><em>vultr</em></strong></a>，价格相对较贵，但是部署服务器较为灵活，按小时进行计费，速度也相对较快。如果对于linux不是很熟悉也可以直接购买第三方提供的Shadowsocks的账号。</p>
<h2>服务器搭建</h2>
<p>在安装完服务器系统后启动系统ssh连接到服务器，搬瓦工服务器同时也提供了一键安装Shadowsocks服务器的功能，这里主要介绍自行安装。</p>
<p>对于Shadowsocks服务端推荐安装<a href="https://github.com/shadowsocks/shadowsocks-libev" target="_blank" rel="external"><em>shadowsocks-libev</em></a>，按照其提示安装完之后</p>
<p>建立一个shadowsocks-config.json文件，写入一下内容：</p>
<p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    "server":"server_ip",   # server ip</div><div class="line">    "server_port":65432,     # server port</div><div class="line">    "password":"password",   # password</div><div class="line">    "timeout":60,            </div><div class="line">    "method":"aes-256-cfb"</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其中server_ip填入vps的ip地址，server_port自定义一个未被占用的端口，password自定义一个密码</p>
<p>然后通过ss-server命令启动：</p>
<p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ss-server -c shadowsocks-config.json -f /tmp/ss.pid</div></pre></td></tr></table></figure></p>
<h1>客户端搭建</h1>
<h2>Mac &amp; Windows</h2>
<p>Shadowsocks都提供了<a href="/uploads/shadowsocks/MaxOS/ShadowsocksX-2.6.3.dmg"><strong><em>Mac</em></strong></a>和<a href="/uploads/shadowsocks/Windows/Shadowsocks-3.3.5.zip"><strong><em>Windows</em></strong></a>的GUI客户端</p>
<p>下载安装完毕之后，会出现一个纸飞机的小图标即是shadowsocks，单击出现以下:<img src="/images/shadowsocks/shadowsocks.png" alt=""></p>
<p>打开shadowsocks后选择模式为Auto Proxy Mode(这样不用翻墙的网站就可以不用走代理了)，</p>
<p>然后添加服务器，如下图所示，将服务器的地址，端口号，加密方式以及密码填入</p>
<p><img src="/images/shadowsocks/server.png" alt=""></p>
<p>打开浏览器访问下***<a href="http://www.google.com/" target="_blank" rel="external">google</a>***试下是否配置成功</p>
<h2>Linux</h2>
<p>Linux虽然也有对应的GUI客户端，但是比较简陋，这里介绍命令行配置的方法。</p>
<p>首先按照服务器的方法按照<a href="https://github.com/shadowsocks/shadowsocks-libev" target="_blank" rel="external"><em>shadowsocks-libev</em></a>，创建shadowsocks-config.json文件</p>
<p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">"server":"server_ip",</div><div class="line">"server_port":65432,</div><div class="line">"local_address": "127.0.0.1",</div><div class="line">"local_port":1080,</div><div class="line">"password":"password",</div><div class="line">"timeout":600,</div><div class="line">"method":"aes-256-cfb",</div><div class="line">"fast_open": false,</div><div class="line">"workers": 1</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>按照服务器的配置填入上面的各个设置，然后使用ss-local启动</p>
<p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">nohup ss-local -c shadowsocks-config.json &amp;</div></pre></td></tr></table></figure></p>
<h2>iOS</h2>
<p>iOS上的很多客户端都是收费的，这里推荐一个免费的兼容shadowsocks的客户端<a href="https://www.wingy.site/" target="_blank" rel="external">Wingy</a>，直接AppStore搜索安装即可。</p>
<p>一个比较方便的功能是wingy支持二维码扫描添加，二维码可以有WIndows或者Mac的客户端生成，当然也可以自行手动添加。</p>
<h2>Chrome</h2>
<p>在安装完Shadowsocks后，作者在MAC上采用Safari可以直接翻墙，但是Chrome不可以，不太了解什么原因，后在Chrome安装了<a href="chrome-extension://padekgcemlokbadohgkifijomclgjgif/options.html#/about" target="_blank" rel="external">SwitchyOmega</a>才成功</p>
<p>安装完SwithyOmega之后打开进行设置，首先设置代理服务器</p>
<p><img src="/images/shadowsocks/switchyomega_proxy.png" alt=""></p>
<p>设置协议为<em>SOCKS5</em>，服务器的地址就是上面填写的<em>local_address</em>和<em>端口号</em>，默认为localhost和1080</p>
<p>然后设置autoswitch，添加规则列表，规则列表可从https://raw.githubusercontent.com/gfwlist/gfwlist/master/gfwlist.txt 下载</p>
<p><img src="/images/shadowsocks/switchyomega_autoswitch.png" alt=""></p>
<p>对于一些规则列表中没有的网站也可以手动添加</p>
<h2>终端</h2>
<p>很多的时候需要在终端上进行翻墙，可以采用<strong><em>proxchain-ng</em></strong>实现socks5的代理</p>
<h3>Mac</h3>
<p>对于Mac用户可以通过brew直接安装</p>
<p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">brew install proxychains-ng</div></pre></td></tr></table></figure></p>
<h3>Linux</h3>
<h4>下载源代码</h4>
<p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">git clone https://github.com/rofl0r/proxychains-ng.git</div><div class="line">cd proxychains-ng</div></pre></td></tr></table></figure></p>
<h4>编译安装</h4>
<p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">./configure --prefix=/usr --sysconfdir=/etc</div><div class="line">make &amp; make install</div></pre></td></tr></table></figure></p>
<p>其中—prefix为安装目录，—sysconfdir为配置文件目录</p>
<h4>添加配置文件</h4>
<p>修改配置文件<strong>proxychains.conf</strong></p>
<p>最后加入</p>
<p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">socks5  127.0.0.1 1080 //可以根据自己ss的配置进行更改</div></pre></td></tr></table></figure></p>
<h4>测试和使用</h4>
<p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">proxychain4 curl ip.gs</div></pre></td></tr></table></figure></p>
<p>如果显示的ip地址为vps服务器的地址，则配置成功。</p>
<p>以后在需要代理的命令前加上proxychain4即可。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="www.wangkejie.me/2016/06/04/rasp-gpio/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kejie Wang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kejie Wang">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/06/04/rasp-gpio/" itemprop="url">树莓派上的GPIO字符驱动程序</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-06-04T00:00:00+08:00">
                2016-06-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/EmbededSystem/" itemprop="url" rel="index">
                    <span itemprop="name">EmbededSystem</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/06/04/rasp-gpio/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count fb-comments-count" data-href="www.wangkejie.me/2016/06/04/rasp-gpio/" itemprop="commentCount">0</span> comments
                </a>
              </span>
            
          

          
          
             <span id="/2016/06/04/rasp-gpio/" class="leancloud_visitors" data-flag-title="树莓派上的GPIO字符驱动程序">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Visitors </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>主要是在嵌入式Linux（树莓派）中如何使用已有的函数库编写应用程序操纵GPIO，如何编写字符设备驱动程序在内核程序中使用GPIO
&lt;!-- more --&gt;</p>
<h1>硬件连接图</h1>
<p><img src="/images/rasp-gpio/dev-conn.png" alt="树莓派和MAX7219连接图"></p>
<h1>虚拟文件系统操作GPIO</h1>
<p>Linux可以通过访问sys/class/gpio下的一些文件，通过对这些文件的读写来实现对于GPIO的访问。
树莓派下面的可用的GPIO如下图所示(需要注意树莓派一代和二代的区别)：
<img src="/images/rasp-gpio/rasp-gpio-map.png" alt="">
首先用一个小灯来测试下操作。首先向export中写入18，表示启用18号gpio端口，执行之后，可以看到该目录下多出了一个gpio18的目录。进入该目录后，先direction中写入out，表示该gpio作为输出，然后向value文件中写入1，表示其输出1，小灯的一端接gpio18，另一端接地，就可以看到小灯点亮。实验成功。
<img src="/images/rasp-gpio/sys-eg.png" alt=""></p>
<p>将其改装成用C操作文件的方式进行，这里我写了一个简单的库，包括gpio的export和unexport以及read和write:
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//gpio_sys.h</span></div><div class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _GPIO_SYS_H_</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> _GPIO_SYS_H_</span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> BUFFMAX 3</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> SYSFS_GPIO_EXPORT     <span class="meta-string">"/sys/class/gpio/export"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> SYSFS_GPIO_UNEXPORT <span class="meta-string">"/sys/class/gpio/unexport"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> SYSFS_GPIO_DIR_IN    0</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> SYSFS_GPIO_DIR_OUT    1</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> SYSFS_GPIO_VAL_HIGH 1</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> SYSFS_GPIO_VAL_LOW    0</span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> ERR(args...) fprintf(stderr, <span class="meta-string">"%s\n"</span>, args);</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">GPIOExport</span><span class="params">(<span class="keyword">int</span> pin)</span></span>;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">GPIOUnexport</span><span class="params">(<span class="keyword">int</span> pin)</span></span>;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">GPIODirection</span><span class="params">(<span class="keyword">int</span> pin, <span class="keyword">int</span> dir)</span></span>;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">GPIORead</span><span class="params">(<span class="keyword">int</span> pin)</span></span>;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">GPIOWrite</span><span class="params">(<span class="keyword">int</span> pin, <span class="keyword">int</span> value)</span></span>;</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div></pre></td></tr></table></figure></p>
<p><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//gpio_sys.c</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"gpio_sys.h"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">GPIOExport</span><span class="params">(<span class="keyword">int</span> pin)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">char</span> buff[BUFFMAX];</div><div class="line"></div><div class="line">    <span class="keyword">int</span> fd;</div><div class="line">    <span class="keyword">if</span>((fd=open(SYSFS_GPIO_EXPORT, O_WRONLY)) == <span class="number">-1</span>)</div><div class="line">    &#123;</div><div class="line">        ERR(<span class="string">"Failed to open export for writing!\n"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> len = <span class="built_in">snprintf</span>(buff, <span class="keyword">sizeof</span>(buff), <span class="string">"%d"</span>, pin);</div><div class="line">    <span class="keyword">if</span>(write(fd, buff, len) == <span class="number">-1</span>)</div><div class="line">    &#123;</div><div class="line">        ERR(<span class="string">"Failed to export gpio!\n"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span>(close(fd) == <span class="number">-1</span>)</div><div class="line">    &#123;</div><div class="line">        ERR(<span class="string">"Failed to close export!\n"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">GPIOUnexport</span><span class="params">(<span class="keyword">int</span> pin)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">char</span> buff[BUFFMAX];</div><div class="line">    <span class="keyword">int</span> fd;</div><div class="line">    <span class="keyword">if</span>((fd=open(SYSFS_GPIO_UNEXPORT, O_WRONLY)) == <span class="number">-1</span>)</div><div class="line">    &#123;</div><div class="line">        ERR(<span class="string">"Failed to open unexport for writing!\n"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="number">-1</span>;        </div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> len = <span class="built_in">snprintf</span>(buff, <span class="keyword">sizeof</span>(buff), <span class="string">"%d"</span>, pin);</div><div class="line">    <span class="keyword">if</span>(write(fd, buff, len) == <span class="number">-1</span>)</div><div class="line">    &#123;</div><div class="line">        ERR(<span class="string">"Failed to unexport gpio!\n"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span>(close(fd) == <span class="number">-1</span>)</div><div class="line">    &#123;</div><div class="line">        ERR(<span class="string">"Failed to close unexport!\n"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">GPIODirection</span><span class="params">(<span class="keyword">int</span> pin, <span class="keyword">int</span> dir)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">char</span> dirCh[][<span class="number">5</span>] =  &#123;<span class="string">"in"</span>, <span class="string">"out"</span>&#125;;</div><div class="line">    <span class="keyword">char</span> path[<span class="number">64</span>];</div><div class="line"></div><div class="line">    <span class="keyword">int</span> fd;</div><div class="line">    <span class="built_in">snprintf</span>(path, <span class="keyword">sizeof</span>(path), <span class="string">"/sys/class/gpio/gpio%d/direction"</span>, pin);</div><div class="line">    <span class="built_in">printf</span>(path);</div><div class="line">    <span class="keyword">if</span>((fd = open(path, O_WRONLY)) == <span class="number">-1</span>)</div><div class="line">    &#123;</div><div class="line">        ERR(<span class="string">"Failed to open direction for writing!\n"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="number">-1</span>;    </div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span>(write(fd, dirCh[dir], <span class="built_in">strlen</span>(dirCh[dir])) == <span class="number">-1</span>)</div><div class="line">    &#123;</div><div class="line">        ERR(<span class="string">"Failed to set direction!\n"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="number">-1</span>;        </div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span>(close(fd) == <span class="number">-1</span>)</div><div class="line">    &#123;</div><div class="line">        ERR(<span class="string">"Failed to close direction!\n"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">GPIORead</span><span class="params">(<span class="keyword">int</span> pin)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">char</span> path[<span class="number">64</span>];</div><div class="line">    <span class="keyword">char</span> buff[BUFFMAX];</div><div class="line"></div><div class="line">    <span class="built_in">snprintf</span>(path, <span class="keyword">sizeof</span>(path), <span class="string">"/sys/class/gpio/gpio%d/value"</span>, pin);</div><div class="line"></div><div class="line">    <span class="keyword">int</span> fd;</div><div class="line">    <span class="keyword">if</span>((fd == open(path, O_RDONLY)) == <span class="number">-1</span>)</div><div class="line">    &#123;</div><div class="line">        ERR(<span class="string">"Failed to open value for reading!\n"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="number">-1</span>;    </div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span>(read(fd, buff, <span class="keyword">sizeof</span>(buff)) == <span class="number">-1</span>)</div><div class="line">    &#123;</div><div class="line">        ERR(<span class="string">"Failed to read value!\n"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span>(close(fd) == <span class="number">-1</span>)</div><div class="line">    &#123;</div><div class="line">        ERR(<span class="string">"Failed to close value!\n"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> atoi(buff);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">GPIOWrite</span><span class="params">(<span class="keyword">int</span> pin, <span class="keyword">int</span> value)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">char</span> path[<span class="number">64</span>];</div><div class="line">    <span class="keyword">char</span> valuestr[][<span class="number">2</span>] = &#123;<span class="string">"0"</span>, <span class="string">"1"</span>&#125;;</div><div class="line"></div><div class="line">    <span class="keyword">if</span>(value != <span class="number">0</span> &amp;&amp; value != <span class="number">1</span>)</div><div class="line">    &#123;</div><div class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"value = %d\n"</span>, value);</div><div class="line">        ERR(<span class="string">"Writing erro value!\n"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">snprintf</span>(path, <span class="keyword">sizeof</span>(path), <span class="string">"/sys/class/gpio/gpio%d/value"</span>, pin);</div><div class="line">    <span class="keyword">int</span> fd;</div><div class="line">    <span class="keyword">if</span>((fd = open(path, O_WRONLY)) == <span class="number">-1</span>)</div><div class="line">    &#123;</div><div class="line">        ERR(<span class="string">"Failed to open value for writing!\n"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="number">-1</span>;    </div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span>(write(fd, valuestr[value], <span class="number">1</span>) == <span class="number">-1</span>)</div><div class="line">    &#123;</div><div class="line">        ERR(<span class="string">"Failed to write value!\n"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span>(close(fd) == <span class="number">-1</span>)</div><div class="line">    &#123;</div><div class="line">        ERR(<span class="string">"Failed to close value!\n"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><img src="/images/rasp-gpio/max7219.png" alt="">
然后编写MAX_7219的显示程序。</p>
<p>MAX_7219其输出引DIG0-7和SEG A-G连接了8<em>8的LED矩阵，而我们关心的则是其输入的5个引脚，分别是5V的VCC和接地GND，以及时钟信号CLK，片选信号CS，串行数据输入端口DIN
MAX_7219使用前需要对一些寄存器进行初始化设置，包括编码寄存器，亮度寄存器，模式寄存器以及显示检测寄存器。
<img src="/images/rasp-gpio/max7219-reg.png" alt="">
MAX_7219的数据的写入是在时钟上升沿写入的，连续数据的后16位被移入寄存器中，其中8-11为地址，0-7位为数据。
在了解了MAX_7219的工作原理之后就可以使用上面的gpio的操纵函数进行字母的显示了。下面给出的是在8</em>8的矩阵上依次显示0-9,a-z以及中国字样的程序。
采用的GPIO为gpio18，gpio23和gpio24分别连接CLK，CS以及DIN。
首先需要对于树莓派的GPIO口进行一些配置:
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Init_MAX7219</span><span class="params">(<span class="keyword">void</span>)</span>    </span></div><div class="line">&#123;</div><div class="line">     Write_Max7219(<span class="number">0x09</span>, <span class="number">0x00</span>);       <span class="comment">//encoding with BCD</span></div><div class="line">     Write_Max7219(<span class="number">0x0a</span>, <span class="number">0x03</span>);       <span class="comment">//luminance</span></div><div class="line">     Write_Max7219(<span class="number">0x0b</span>, <span class="number">0x07</span>);       <span class="comment">//scanning bound</span></div><div class="line">     Write_Max7219(<span class="number">0x0c</span>, <span class="number">0x01</span>);       <span class="comment">//mode: normal</span></div><div class="line">     Write_Max7219(<span class="number">0x0f</span>, <span class="number">0x00</span>);       </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>初始化MAX_7219的一些寄存器，设置其译码方式为BCD译码，亮度为3，扫描界限为8个数码管显示，采用普通模式，正常显示
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Init_MAX7219</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">     Write_Max7219(<span class="number">0x09</span>, <span class="number">0x00</span>);       <span class="comment">//encoding with BCD</span></div><div class="line">     Write_Max7219(<span class="number">0x0a</span>, <span class="number">0x03</span>);       <span class="comment">//luminance</span></div><div class="line">     Write_Max7219(<span class="number">0x0b</span>, <span class="number">0x07</span>);       <span class="comment">//scanning bound</span></div><div class="line">     Write_Max7219(<span class="number">0x0c</span>, <span class="number">0x01</span>);       <span class="comment">//mode: normal</span></div><div class="line">     Write_Max7219(<span class="number">0x0f</span>, <span class="number">0x00</span>);       </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后编写数据写入函数，其首先将地址写入，然后在将数据写入。其中写入的顺序为从高位到低位按位依次写入即可。写入的时候首先将CLK设为低电平，然后使得数据有限，然后将CLK设为高电平，让数据在上升沿时写入
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Write_Max7219_byte</span><span class="params">(uchar DATA)</span>         </span></div><div class="line">&#123;</div><div class="line">    uchar i;   </div><div class="line">    GPIOWrite(pinCS, SYSFS_GPIO_VAL_LOW);</div><div class="line">    <span class="keyword">for</span>(i=<span class="number">8</span>;i&gt;=<span class="number">1</span>;i--)</div><div class="line">    &#123;</div><div class="line">        GPIOWrite(pinCLK, SYSFS_GPIO_VAL_LOW);</div><div class="line">        GPIOWrite(pinDIN, (DATA&amp;<span class="number">0x80</span>) &gt;&gt; <span class="number">7</span>);</div><div class="line">        DATA &lt;&lt;= <span class="number">1</span>;</div><div class="line">        GPIOWrite(pinCLK, SYSFS_GPIO_VAL_HIGH);</div><div class="line">    &#125;                                 </div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Write_Max7219</span><span class="params">(uchar address,uchar dat)</span></span></div><div class="line">&#123;</div><div class="line">     GPIOWrite(pinCS, SYSFS_GPIO_VAL_LOW);</div><div class="line">     Write_Max7219_byte(address);           <span class="comment">//writing address</span></div><div class="line">     Write_Max7219_byte(dat);               <span class="comment">//writing data</span></div><div class="line">     GPIOWrite(pinCS, SYSFS_GPIO_VAL_HIGH);                      </div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Init_MAX7219</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">     Write_Max7219(<span class="number">0x09</span>, <span class="number">0x00</span>);       <span class="comment">//encoding with BCD</span></div><div class="line">     Write_Max7219(<span class="number">0x0a</span>, <span class="number">0x03</span>);       <span class="comment">//luminance</span></div><div class="line">     Write_Max7219(<span class="number">0x0b</span>, <span class="number">0x07</span>);       <span class="comment">//scanning bound</span></div><div class="line">     Write_Max7219(<span class="number">0x0c</span>, <span class="number">0x01</span>);       <span class="comment">//mode: normal</span></div><div class="line">     Write_Max7219(<span class="number">0x0f</span>, <span class="number">0x00</span>);       </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>最后将上述过程拼接起来就可以了。
连接线路然后运行就可以看到字符输出了，下面列出了8， W，中的显示图像。
&lt;img src=&quot;/images/rasp-gpio/ch-zhong-img.png&quot; width=&quot;50%&quot; height=&quot;50%&quot;&gt;</p>
<p><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">define</span> uchar unsigned char</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> uint  unsigned int</span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> pinCLK     18</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> pinCS     23</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> pinDIN     24</span></div><div class="line"></div><div class="line">uchar codeDisp[<span class="number">38</span>][<span class="number">8</span>]=&#123;</div><div class="line">    &#123;<span class="number">0x3C</span>,<span class="number">0x42</span>,<span class="number">0x42</span>,<span class="number">0x42</span>,<span class="number">0x42</span>,<span class="number">0x42</span>,<span class="number">0x42</span>,<span class="number">0x3C</span>&#125;,<span class="comment">//0</span></div><div class="line">    &#123;<span class="number">0x10</span>,<span class="number">0x18</span>,<span class="number">0x14</span>,<span class="number">0x10</span>,<span class="number">0x10</span>,<span class="number">0x10</span>,<span class="number">0x10</span>,<span class="number">0x10</span>&#125;,<span class="comment">//1</span></div><div class="line">    &#123;<span class="number">0x7E</span>,<span class="number">0x2</span>,<span class="number">0x2</span>,<span class="number">0x7E</span>,<span class="number">0x40</span>,<span class="number">0x40</span>,<span class="number">0x40</span>,<span class="number">0x7E</span>&#125;,<span class="comment">//2</span></div><div class="line">    &#123;<span class="number">0x3E</span>,<span class="number">0x2</span>,<span class="number">0x2</span>,<span class="number">0x3E</span>,<span class="number">0x2</span>,<span class="number">0x2</span>,<span class="number">0x3E</span>,<span class="number">0x0</span>&#125;,<span class="comment">//3</span></div><div class="line">    &#123;<span class="number">0x8</span>,<span class="number">0x18</span>,<span class="number">0x28</span>,<span class="number">0x48</span>,<span class="number">0xFE</span>,<span class="number">0x8</span>,<span class="number">0x8</span>,<span class="number">0x8</span>&#125;,<span class="comment">//4</span></div><div class="line">    &#123;<span class="number">0x3C</span>,<span class="number">0x20</span>,<span class="number">0x20</span>,<span class="number">0x3C</span>,<span class="number">0x4</span>,<span class="number">0x4</span>,<span class="number">0x3C</span>,<span class="number">0x0</span>&#125;,<span class="comment">//5</span></div><div class="line">    &#123;<span class="number">0x3C</span>,<span class="number">0x20</span>,<span class="number">0x20</span>,<span class="number">0x3C</span>,<span class="number">0x24</span>,<span class="number">0x24</span>,<span class="number">0x3C</span>,<span class="number">0x0</span>&#125;,<span class="comment">//6</span></div><div class="line">    &#123;<span class="number">0x3E</span>,<span class="number">0x22</span>,<span class="number">0x4</span>,<span class="number">0x8</span>,<span class="number">0x8</span>,<span class="number">0x8</span>,<span class="number">0x8</span>,<span class="number">0x8</span>&#125;,<span class="comment">//7</span></div><div class="line">    &#123;<span class="number">0x0</span>,<span class="number">0x3E</span>,<span class="number">0x22</span>,<span class="number">0x22</span>,<span class="number">0x3E</span>,<span class="number">0x22</span>,<span class="number">0x22</span>,<span class="number">0x3E</span>&#125;,<span class="comment">//8</span></div><div class="line">    &#123;<span class="number">0x3E</span>,<span class="number">0x22</span>,<span class="number">0x22</span>,<span class="number">0x3E</span>,<span class="number">0x2</span>,<span class="number">0x2</span>,<span class="number">0x2</span>,<span class="number">0x3E</span>&#125;,<span class="comment">//9</span></div><div class="line">    &#123;<span class="number">0x8</span>,<span class="number">0x14</span>,<span class="number">0x22</span>,<span class="number">0x3E</span>,<span class="number">0x22</span>,<span class="number">0x22</span>,<span class="number">0x22</span>,<span class="number">0x22</span>&#125;,<span class="comment">//A</span></div><div class="line">    &#123;<span class="number">0x3C</span>,<span class="number">0x22</span>,<span class="number">0x22</span>,<span class="number">0x3E</span>,<span class="number">0x22</span>,<span class="number">0x22</span>,<span class="number">0x3C</span>,<span class="number">0x0</span>&#125;,<span class="comment">//B</span></div><div class="line">    &#123;<span class="number">0x3C</span>,<span class="number">0x40</span>,<span class="number">0x40</span>,<span class="number">0x40</span>,<span class="number">0x40</span>,<span class="number">0x40</span>,<span class="number">0x3C</span>,<span class="number">0x0</span>&#125;,<span class="comment">//C</span></div><div class="line">    &#123;<span class="number">0x7C</span>,<span class="number">0x42</span>,<span class="number">0x42</span>,<span class="number">0x42</span>,<span class="number">0x42</span>,<span class="number">0x42</span>,<span class="number">0x7C</span>,<span class="number">0x0</span>&#125;,<span class="comment">//D</span></div><div class="line">    &#123;<span class="number">0x7C</span>,<span class="number">0x40</span>,<span class="number">0x40</span>,<span class="number">0x7C</span>,<span class="number">0x40</span>,<span class="number">0x40</span>,<span class="number">0x40</span>,<span class="number">0x7C</span>&#125;,<span class="comment">//E</span></div><div class="line">    &#123;<span class="number">0x7C</span>,<span class="number">0x40</span>,<span class="number">0x40</span>,<span class="number">0x7C</span>,<span class="number">0x40</span>,<span class="number">0x40</span>,<span class="number">0x40</span>,<span class="number">0x40</span>&#125;,<span class="comment">//F</span></div><div class="line">    &#123;<span class="number">0x3C</span>,<span class="number">0x40</span>,<span class="number">0x40</span>,<span class="number">0x40</span>,<span class="number">0x40</span>,<span class="number">0x44</span>,<span class="number">0x44</span>,<span class="number">0x3C</span>&#125;,<span class="comment">//G</span></div><div class="line">    &#123;<span class="number">0x44</span>,<span class="number">0x44</span>,<span class="number">0x44</span>,<span class="number">0x7C</span>,<span class="number">0x44</span>,<span class="number">0x44</span>,<span class="number">0x44</span>,<span class="number">0x44</span>&#125;,<span class="comment">//H</span></div><div class="line">    &#123;<span class="number">0x7C</span>,<span class="number">0x10</span>,<span class="number">0x10</span>,<span class="number">0x10</span>,<span class="number">0x10</span>,<span class="number">0x10</span>,<span class="number">0x10</span>,<span class="number">0x7C</span>&#125;,<span class="comment">//I</span></div><div class="line">    &#123;<span class="number">0x3C</span>,<span class="number">0x8</span>,<span class="number">0x8</span>,<span class="number">0x8</span>,<span class="number">0x8</span>,<span class="number">0x8</span>,<span class="number">0x48</span>,<span class="number">0x30</span>&#125;,<span class="comment">//J</span></div><div class="line">    &#123;<span class="number">0x0</span>,<span class="number">0x24</span>,<span class="number">0x28</span>,<span class="number">0x30</span>,<span class="number">0x20</span>,<span class="number">0x30</span>,<span class="number">0x28</span>,<span class="number">0x24</span>&#125;,<span class="comment">//K</span></div><div class="line">    &#123;<span class="number">0x40</span>,<span class="number">0x40</span>,<span class="number">0x40</span>,<span class="number">0x40</span>,<span class="number">0x40</span>,<span class="number">0x40</span>,<span class="number">0x40</span>,<span class="number">0x7C</span>&#125;,<span class="comment">//L</span></div><div class="line">    &#123;<span class="number">0x81</span>,<span class="number">0xC3</span>,<span class="number">0xA5</span>,<span class="number">0x99</span>,<span class="number">0x81</span>,<span class="number">0x81</span>,<span class="number">0x81</span>,<span class="number">0x81</span>&#125;,<span class="comment">//M</span></div><div class="line">    &#123;<span class="number">0x0</span>,<span class="number">0x42</span>,<span class="number">0x62</span>,<span class="number">0x52</span>,<span class="number">0x4A</span>,<span class="number">0x46</span>,<span class="number">0x42</span>,<span class="number">0x0</span>&#125;,<span class="comment">//N</span></div><div class="line">    &#123;<span class="number">0x3C</span>,<span class="number">0x42</span>,<span class="number">0x42</span>,<span class="number">0x42</span>,<span class="number">0x42</span>,<span class="number">0x42</span>,<span class="number">0x42</span>,<span class="number">0x3C</span>&#125;,<span class="comment">//O</span></div><div class="line">    &#123;<span class="number">0x3C</span>,<span class="number">0x22</span>,<span class="number">0x22</span>,<span class="number">0x22</span>,<span class="number">0x3C</span>,<span class="number">0x20</span>,<span class="number">0x20</span>,<span class="number">0x20</span>&#125;,<span class="comment">//P</span></div><div class="line">    &#123;<span class="number">0x1C</span>,<span class="number">0x22</span>,<span class="number">0x22</span>,<span class="number">0x22</span>,<span class="number">0x22</span>,<span class="number">0x26</span>,<span class="number">0x22</span>,<span class="number">0x1D</span>&#125;,<span class="comment">//Q</span></div><div class="line">    &#123;<span class="number">0x3C</span>,<span class="number">0x22</span>,<span class="number">0x22</span>,<span class="number">0x22</span>,<span class="number">0x3C</span>,<span class="number">0x24</span>,<span class="number">0x22</span>,<span class="number">0x21</span>&#125;,<span class="comment">//R</span></div><div class="line">    &#123;<span class="number">0x0</span>,<span class="number">0x1E</span>,<span class="number">0x20</span>,<span class="number">0x20</span>,<span class="number">0x3E</span>,<span class="number">0x2</span>,<span class="number">0x2</span>,<span class="number">0x3C</span>&#125;,<span class="comment">//S</span></div><div class="line">    &#123;<span class="number">0x0</span>,<span class="number">0x3E</span>,<span class="number">0x8</span>,<span class="number">0x8</span>,<span class="number">0x8</span>,<span class="number">0x8</span>,<span class="number">0x8</span>,<span class="number">0x8</span>&#125;,<span class="comment">//T</span></div><div class="line">    &#123;<span class="number">0x42</span>,<span class="number">0x42</span>,<span class="number">0x42</span>,<span class="number">0x42</span>,<span class="number">0x42</span>,<span class="number">0x42</span>,<span class="number">0x22</span>,<span class="number">0x1C</span>&#125;,<span class="comment">//U</span></div><div class="line">    &#123;<span class="number">0x42</span>,<span class="number">0x42</span>,<span class="number">0x42</span>,<span class="number">0x42</span>,<span class="number">0x42</span>,<span class="number">0x42</span>,<span class="number">0x24</span>,<span class="number">0x18</span>&#125;,<span class="comment">//V</span></div><div class="line">    &#123;<span class="number">0x0</span>,<span class="number">0x49</span>,<span class="number">0x49</span>,<span class="number">0x49</span>,<span class="number">0x49</span>,<span class="number">0x2A</span>,<span class="number">0x1C</span>,<span class="number">0x0</span>&#125;,<span class="comment">//W</span></div><div class="line">    &#123;<span class="number">0x0</span>,<span class="number">0x41</span>,<span class="number">0x22</span>,<span class="number">0x14</span>,<span class="number">0x8</span>,<span class="number">0x14</span>,<span class="number">0x22</span>,<span class="number">0x41</span>&#125;,<span class="comment">//X</span></div><div class="line">    &#123;<span class="number">0x41</span>,<span class="number">0x22</span>,<span class="number">0x14</span>,<span class="number">0x8</span>,<span class="number">0x8</span>,<span class="number">0x8</span>,<span class="number">0x8</span>,<span class="number">0x8</span>&#125;,<span class="comment">//Y</span></div><div class="line">    &#123;<span class="number">0x0</span>,<span class="number">0x7F</span>,<span class="number">0x2</span>,<span class="number">0x4</span>,<span class="number">0x8</span>,<span class="number">0x10</span>,<span class="number">0x20</span>,<span class="number">0x7F</span>&#125;,<span class="comment">//Z</span></div><div class="line">    &#123;<span class="number">0x8</span>,<span class="number">0x7F</span>,<span class="number">0x49</span>,<span class="number">0x49</span>,<span class="number">0x7F</span>,<span class="number">0x8</span>,<span class="number">0x8</span>,<span class="number">0x8</span>&#125;,<span class="comment">//中</span></div><div class="line">    &#123;<span class="number">0xFE</span>,<span class="number">0xBA</span>,<span class="number">0x92</span>,<span class="number">0xBA</span>,<span class="number">0x92</span>,<span class="number">0x9A</span>,<span class="number">0xBA</span>,<span class="number">0xFE</span>&#125;,<span class="comment">//国</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Delay_xms</span><span class="params">(uint x)</span></span></div><div class="line">&#123;</div><div class="line">    uint i,j;</div><div class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;x;i++)</div><div class="line">        <span class="keyword">for</span>(j=<span class="number">0</span>;j&lt;<span class="number">50000</span>;j++);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">    uchar i,j;</div><div class="line">     Delay_xms(<span class="number">50</span>);</div><div class="line">     <span class="keyword">if</span>(GPIOConfig() == <span class="number">-1</span>)</div><div class="line">     &#123;</div><div class="line">         ERR(<span class="string">"Can not configure the gpio!\n"</span>)</div><div class="line">         <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">     &#125;</div><div class="line">     Init_MAX7219();</div><div class="line">     <span class="keyword">while</span>(<span class="number">1</span>)</div><div class="line">     &#123;</div><div class="line">          <span class="keyword">for</span>(j=<span class="number">0</span>;j&lt;<span class="number">38</span>;j++)</div><div class="line">          &#123;</div><div class="line">               <span class="keyword">for</span>(i=<span class="number">1</span>;i&lt;<span class="number">9</span>;i++)</div><div class="line">                Write_Max7219(i,codeDisp[j][i<span class="number">-1</span>]);</div><div class="line">               Delay_xms(<span class="number">1000</span>);</div><div class="line">          &#125;  </div><div class="line">     &#125;</div><div class="line"></div><div class="line">     <span class="keyword">if</span>(GPIORelease() == <span class="number">-1</span>)</div><div class="line">     &#123;</div><div class="line">         ERR(<span class="string">"Release the gpio error!\n"</span>)</div><div class="line">         <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">     &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1>字符驱动程序</h1>
<p>对于通过寄存器操作GPIO，我们就需要知道树莓派上各个GPIO端口的寄存器的地址，在树莓派的CPU<a href="https://www.raspberrypi.org/wp-content/uploads/2012/02/BCM2835-ARM-Peripherals.pdf" target="_blank" rel="external">bcm2825</a>的芯片手册上可以查到
<img src="/images/rasp-gpio/bcm2825.png" alt="">
且由于树莓派的IO的空间的起始地址是0xF2000000，并且GPIO的偏移地址为0x200000，那么真实的GPIO的开始地址为0xF2200000,这个数据可以通过&lt;mach/platform.h&gt;这个头文件中的GPIO_BASE获得。
根据上面说列出的信息，就可以编写我们的对于GPIO端口的操作函数了，这里定义了对于GPIO口的function selection, set以及clear三个函数。
在网上的一篇博客中还看到可以通过树莓派提供的一些列的gpiochip的包装的函数进行操作，但是尝试了很久没有成功，驱动程序报错。编写这个程序也可以参考网上可以下载到的bcm2835的对于GPIO操作的一个bcm2835的一个开源的函数库</p>
<p><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//0-&gt;input  1-&lt;output</span></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">bcm2835_gpio_fsel</span><span class="params">(<span class="keyword">int</span> pin, <span class="keyword">int</span> functionCode)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">int</span> registerIndex = pin / <span class="number">10</span>;</div><div class="line">    <span class="keyword">int</span> bit = (pin % <span class="number">10</span>) * <span class="number">3</span>;</div><div class="line"></div><div class="line">    <span class="keyword">unsigned</span> oldValue = s_pGpioRegisters-&gt; GPFSEL[registerIndex];</div><div class="line">    <span class="keyword">unsigned</span> mask = <span class="number">0b111</span> &lt;&lt; bit;</div><div class="line">    printk(<span class="string">"Changing function of GPIO%d from %x to %x\n"</span>,</div><div class="line">           pin,</div><div class="line">           (oldValue &gt;&gt; bit) &amp; <span class="number">0b111</span>,</div><div class="line">           functionCode);</div><div class="line"></div><div class="line">    s_pGpioRegisters-&gt; GPFSEL[registerIndex] =</div><div class="line">        (oldValue &amp; ~mask) | ((functionCode &lt;&lt; bit) &amp; mask);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">bcm2835_gpio_set</span><span class="params">(<span class="keyword">int</span> pin)</span></span></div><div class="line">&#123;</div><div class="line">    printk(<span class="string">"GPIO set %d\n oldValue=%d"</span>, pin, s_pGpioRegisters-&gt;GPSET[<span class="number">0</span>]);</div><div class="line">    s_pGpioRegisters-&gt; GPSET[pin / <span class="number">32</span>] = (<span class="number">1</span> &lt;&lt; (pin % <span class="number">32</span>));      </div><div class="line">    printk(<span class="string">"GPIO set %d\n oldValue=%d"</span>, pin, s_pGpioRegisters-&gt;GPSET[<span class="number">0</span>]);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">bcm2835_gpio_clr</span><span class="params">(<span class="keyword">int</span> pin)</span></span></div><div class="line">&#123;</div><div class="line">    printk(<span class="string">"GPIO clear %d\n oldValue=%d"</span>, pin, s_pGpioRegisters-&gt;GPCLR[<span class="number">0</span>]);</div><div class="line">    s_pGpioRegisters-&gt; GPCLR[pin / <span class="number">32</span>] = (<span class="number">1</span> &lt;&lt; (pin % <span class="number">32</span>));</div><div class="line">    printk(<span class="string">"GPIO clear %d\n newValue=%d"</span>, pin, s_pGpioRegisters-&gt;GPCLR[<span class="number">0</span>]);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在完成对于GPIO的操作函数之后就可以开始编写字符驱动程序了，Linux的字符驱动程序主要以模块的形式装载到内核中，然后应用程序通过文件的操作的方式对于硬件进行操作。编写一个Linux的字符驱动程序主要如下图所示：
<img src="/images/rasp-gpio/linux-ch-driver.jpg" alt="">
如上图所示，首先需要做的是对于驱动进行初始化设置，在模块的初始化函数中编写如下，首先获得一个设备号（静态或者动态获取），然后进行字符设备的初始化，主要是将file_operation这个结构体中的函数和我们的定义的函数进行一个绑定，注册字符设备，最后创建得到设备。然后在进行设备的初始化，这里首先获取的是GPIO寄存器的基地址，然后通过fsel函数设置相关的三个GPIO口的模式为OUT，然后通过这三个GPIO去初始化MAX7219（同上）
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">MAX7219_cdev_fops</span> = &#123;</span></div><div class="line">    .owner = THIS_MODULE,</div><div class="line">    .open = MAX7219_open,</div><div class="line">    .write = MAX7219_write,</div><div class="line">    .release = MAX7219_release,</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">MAX7219_init</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">int</span> ret;</div><div class="line"></div><div class="line">    MAX7219_dev_id = MKDEV(major, <span class="number">0</span>);</div><div class="line">    <span class="keyword">if</span>(major)    <span class="comment">//static allocate</span></div><div class="line">        ret = register_chrdev_region(MAX7219_dev_id, <span class="number">1</span>, DRIVER_NAME);</div><div class="line">    <span class="keyword">else</span>    <span class="comment">//dynamic allocate</span></div><div class="line">    &#123;</div><div class="line">        ret = alloc_chrdev_region(&amp;MAX7219_dev_id, <span class="number">0</span>, <span class="number">1</span>, DRIVER_NAME);</div><div class="line">        major = MAJOR(MAX7219_dev_id);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span>(ret &lt; <span class="number">0</span>)</div><div class="line">        <span class="keyword">return</span> ret;</div><div class="line"></div><div class="line">    cdev_init(&amp;MAX7219_cdev, &amp;MAX7219_cdev_fops);    <span class="comment">//initialize character dev</span></div><div class="line">    cdev_add(&amp;MAX7219_cdev, MAX7219_dev_id, <span class="number">1</span>);                <span class="comment">//register character device</span></div><div class="line">    MAX7219_class = class_create(THIS_MODULE, DRIVER_NAME);    <span class="comment">//create a class</span></div><div class="line">    device_create(MAX7219_class, <span class="literal">NULL</span>, MAX7219_dev_id, <span class="literal">NULL</span>, DRIVER_NAME);    <span class="comment">//create a dev</span></div><div class="line"></div><div class="line">    s_pGpioRegisters = (struct GpioRegisters*)__io_address(GPIO_BASE);</div><div class="line"></div><div class="line">    printk(<span class="string">"address = %x\n"</span>, (<span class="keyword">int</span>)__io_address(GPIO_BASE));</div><div class="line"></div><div class="line">    <span class="comment">//gpio configure</span></div><div class="line">    bcm2835_gpio_fsel(pinCLK, <span class="number">1</span>);</div><div class="line">    bcm2835_gpio_fsel(pinCS, <span class="number">1</span>);</div><div class="line">    bcm2835_gpio_fsel(pinDIN, <span class="number">1</span>);</div><div class="line"></div><div class="line">    <span class="comment">//initialize the MAX7219</span></div><div class="line">    Init_MAX7219();</div><div class="line"></div><div class="line">    printk(<span class="string">"MAX7219 init successfully"</span>);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>当这个内核模块退出的时候，需要通过device_destroy函数将这个设备删除，以便设备号可以提供给其他的设备宋，并且将其从注册中删除
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">MAX7219_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">    device_destroy(MAX7219_class, MAX7219_dev_id);</div><div class="line">    class_destroy(MAX7219_class);</div><div class="line">    unregister_chrdev_region(MAX7219_dev_id, <span class="number">1</span>);</div><div class="line">    printk(<span class="string">"MAX7219 exit successfully\n"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后就需要编写file_operations中的函数，这里主要定义了用的open，write和release（close）函数，对于read，iocnl等等就没有进行定义。</p>
<p>Open函数比较简单，主要就是判断下文件是否已经打开，如果已经被打开了，那么其将不能被再次打开</p>
<p><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">MAX7219_open</span><span class="params">(struct inode *inode, struct file *flip)</span></span></div><div class="line">&#123;</div><div class="line">    printk(<span class="string">"Open the MAX7219 device!\n"</span>);</div><div class="line">    <span class="keyword">if</span>(state != <span class="number">0</span>)</div><div class="line">    &#123;</div><div class="line">        printk(<span class="string">"The file is opened!\n"</span>);    </div><div class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">    &#125;</div><div class="line">    state++;</div><div class="line">    printk(<span class="string">"Open MAX7219 successfully!\n"</span>);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Release函数和Open相反，将打开的文件关闭即可
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">MAX7219_release</span><span class="params">(struct inode *inode, struct file *flip)</span></span></div><div class="line">&#123;</div><div class="line">    printk(<span class="string">"Close the MAX7219 device!\n"</span>);</div><div class="line">    <span class="keyword">if</span>(state == <span class="number">1</span>)</div><div class="line">    &#123;</div><div class="line">        state = <span class="number">0</span>;</div><div class="line">        printk(<span class="string">"Close the file successfully!\n"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span></div><div class="line">    &#123;</div><div class="line">        printk(<span class="string">"The file has closed!\n"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里主要是write函数，其将用户送来的一个字符需要显示在MAX7219上，其显示的方法和前面的虚拟文件操作基本相同，只是GPIO口操作调用的函数不同。其首先需要将用户空间传递过来的参数通过copy_from_user函数拷贝到内核空间上，然后将调用相关的显示函数进行显示即可。
对于MAX7219的显示函数这里就没有详细叙述，整个过程都和虚拟文件操作一样，只要将上面的接口改成寄存器操作的接口即可。</p>
<p><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> ssize_t <span class="title">MAX7219_write</span><span class="params">(struct file *filp, <span class="keyword">const</span> <span class="keyword">char</span> __user *buf, <span class="keyword">size_t</span> len, <span class="keyword">loff_t</span> *off)</span></span></div><div class="line">&#123;</div><div class="line">    printk(<span class="string">"Write %s into the MAX7219\n"</span>, buf);</div><div class="line">    <span class="keyword">int</span> ret, i;</div><div class="line">    <span class="keyword">char</span> ch;</div><div class="line">    <span class="keyword">if</span>(len == <span class="number">0</span>)</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span>(copy_from_user(&amp;ch, (<span class="keyword">void</span> *)buf, <span class="number">1</span>))</div><div class="line">        ret = -EFAULT;</div><div class="line">    <span class="keyword">else</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">int</span> index;</div><div class="line">        <span class="keyword">if</span>(ch &gt;= <span class="string">'0'</span> &amp;&amp; ch &lt;= <span class="string">'9'</span>)</div><div class="line">            index = ch - <span class="string">'0'</span>;</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(ch &gt;= <span class="string">'A'</span> &amp;&amp; ch &lt;= <span class="string">'Z'</span>)</div><div class="line">            index = ch - <span class="string">'A'</span> + <span class="number">10</span>;</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(ch &gt;= <span class="string">'a'</span> &amp;&amp; ch &lt;= <span class="string">'z'</span>)</div><div class="line">            index = ch - <span class="string">'a'</span> + <span class="number">10</span>;</div><div class="line">        <span class="keyword">else</span></div><div class="line">            index = <span class="number">36</span>;    <span class="comment">//unknown display 中</span></div><div class="line">        printk(<span class="string">"Write character %c, index=%d\n"</span>, ch, index);</div><div class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">8</span>;i++)</div><div class="line">            Write_Max7219(i+<span class="number">1</span>, codeDisp[index][i]);</div><div class="line"></div><div class="line">        ret = <span class="number">1</span>;    <span class="comment">//write a character</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> ret;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>编写完最后，编写Makefile文件进行编译，这个和上次实验内容相同，这里不再赘述。需要注意的是内核的模块版本号必须要和编译的相同，否则会出现ukonwn parameters之类的错误。上次做好久把内核删掉的只能重新编译一次内核了。
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">ARCH        := arm</div><div class="line">CROSS_COMPILE    := arm-linux-gnueabi-</div><div class="line"></div><div class="line">CC := $(CROSS_COMPILE)gcc</div><div class="line">LD := $(CROSS_COMPILE)ld</div><div class="line"></div><div class="line">obj-m := gpio_chdev.o</div><div class="line"></div><div class="line">KERNELDIR := /home/jack/Documents/course/EmbededSystem/RaspberrySource/modules/lib/modules/4.4.11/build</div><div class="line">PWD = $(shell pwd)</div><div class="line"></div><div class="line">all:</div><div class="line">    make -C $(KERNELDIR) M=$(PWD) modules</div><div class="line">clean:</div><div class="line">    rm -f *.o *.mod.c *.symvers *.order</div></pre></td></tr></table></figure></p>
<p>编写如下的测试程序，以此显示A-Z以及0-9在MAX7219上面</p>
<p><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;  </span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;  </span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;  </span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;  </span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/time.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/fcntl.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;  </span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Delay_xms</span><span class="params">(uint x)</span></span></div><div class="line">&#123;</div><div class="line">    uint i,j;</div><div class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;x;i++)</div><div class="line">        <span class="keyword">for</span>(j=<span class="number">0</span>;j&lt;<span class="number">50000</span>;j++);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span>  </span></div><div class="line">&#123;  </div><div class="line">    <span class="keyword">int</span> fd;</div><div class="line">    <span class="keyword">int</span> ret;</div><div class="line"></div><div class="line">    fd = open(<span class="string">"/dev/MAX7219"</span>, O_WRONLY);  </div><div class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>)</div><div class="line">    &#123;  </div><div class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Fail to open /dev/MAX7219!\n"</span>);</div><div class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">char</span> buff[<span class="number">1</span>];</div><div class="line">    <span class="keyword">int</span> i=<span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">26</span>;i++)</div><div class="line">    &#123;</div><div class="line">        buff[<span class="number">0</span>] = <span class="string">'a'</span> + i;</div><div class="line">        <span class="keyword">if</span>((ret = write(fd, buff, <span class="number">1</span>))&lt;<span class="number">0</span>)</div><div class="line">        &#123;</div><div class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Fail to write /dev/MAX7219! %d\n"</span>, ret);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        Delay_xms(<span class="number">1000</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)</div><div class="line">    &#123;</div><div class="line">        buff[<span class="number">0</span>] = <span class="string">'0'</span> + i;</div><div class="line">        <span class="keyword">if</span>((ret = write(fd, buff, <span class="number">1</span>))&lt;<span class="number">0</span>)</div><div class="line">        &#123;</div><div class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Fail to write /dev/MAX7219! %d\n"</span>, ret);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        Delay_xms(<span class="number">1000</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stdout</span>, <span class="string">"Write /dev/MAX7219 successfully! %d\n"</span>, ret);</div><div class="line">    close(fd);  </div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1>参考链接</h1>
<p><a href="http://blog.csdn.net/embbnux/article/details/17712547?utm_source=tuicool&amp;utm_medium=referral" target="_blank" rel="external">基于树莓派的字符设备内核驱动程序框架编写</a></p>
<p><a href="http://blog.csdn.net/hcx25909/article/details/16860725" target="_blank" rel="external">树莓派linux启动学习之LED控制</a></p>
<p><a href="http://sysprogs.com/VisualKernel/tutorials/raspberry/leddriver/" target="_blank" rel="external">Creating a Basic LED Driver for Raspberry Pi</a></p>
<p><a href="https://www.raspberrypi.org/wp-content/uploads/2012/02/BCM2835-ARM-Peripherals.pdf" target="_blank" rel="external">BCM2835-ARM-Peripherals.pdf</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="www.wangkejie.me/2016/05/27/linux-pthread-socket/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kejie Wang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kejie Wang">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/05/27/linux-pthread-socket/" itemprop="url">Linux下的基于Pthread的多线程Socket编程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-05-27T03:19:00+08:00">
                2016-05-27
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/05/27/linux-pthread-socket/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count fb-comments-count" data-href="www.wangkejie.me/2016/05/27/linux-pthread-socket/" itemprop="commentCount">0</span> comments
                </a>
              </span>
            
          

          
          
             <span id="/2016/05/27/linux-pthread-socket/" class="leancloud_visitors" data-flag-title="Linux下的基于Pthread的多线程Socket编程">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Visitors </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          本文主要基于Linux下的Pthread实现了一个服务器和客户端通过socket进行通信的系统。服务端的程序的设计主要是一个主线程首先调用Socket相关的函数socket，bind， listen在建立服务端的Socket之后，等待Accept上面，如果有新的客户端连接上来，则对于每一个客户端新建一个线程。在每一个客户端的线程中，其接收客户端发送的指令然后返回相关的信息，主线程Socket中默认的Accpet默认是阻塞的，这里采用了Linux中函数fctnl将其设置成非阻塞。除了客户端对应的线程和主线程之外，服务端还存在一个服务端的控制线程，其主要是接受服务端的命令，诸如退出，断开连接等等，对服务端的程序进行控制。客户端的程序为一个阻塞的循环，接受用户的输入然后解析命令进行相关的操作，诸如连接服务端，发送数据等等操作。
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2016/05/27/linux-pthread-socket/">
              Read more &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="www.wangkejie.me/2016/05/21/ucos-stm32-migration/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kejie Wang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kejie Wang">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/05/21/ucos-stm32-migration/" itemprop="url">uC/OS-II在STM32F103上的移植</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-05-21T00:00:00+08:00">
                2016-05-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/EmbededSystem/" itemprop="url" rel="index">
                    <span itemprop="name">EmbededSystem</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/05/21/ucos-stm32-migration/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count fb-comments-count" data-href="www.wangkejie.me/2016/05/21/ucos-stm32-migration/" itemprop="commentCount">0</span> comments
                </a>
              </span>
            
          

          
          
             <span id="/2016/05/21/ucos-stm32-migration/" class="leancloud_visitors" data-flag-title="uC/OS-II在STM32F103上的移植">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Visitors </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2>uC/OS工程的创建和移植</h2>
<p>先在<a href="https://www.micrium.com/download/micrium_stm32xxx_ucos-ii/" target="_blank" rel="external">官方</a>下载uc/os的源代码，下载链接如下，注册之后即可以下载(注意IAR和MDK的区别，IAR版汇编的在MDK上汇编不兼容，改动会比较多)</p>
<p>然后在Keil中新建一个uCOS的工程，选择板子为STM32F103C8，选择CMSIS下的CORE和Device下的Startup，以及Device下的StdPeriph Drivers下的Framework，RCC，和GPIO。新建完成后可以写一个简单的LED灯的Demo测试下灯和工程是否正常</p>
<p><img src="/images/ucos-stm32/led-demo.png" alt=""></p>
<p>&lt;!-- more --&gt;</p>
<p>关于uCOS移植到STM32(Cortex-M3)具体可以参考官方的AN-1018文档。下图是uCOS移植到Cortex-M3的相关代码和模块之间的关系。其中最上面的是应用层，即是我们自己写的程序，然后下面是uCOS源代码，主要对应的是uCOS-II中的Src和Ports文件夹里面的代码。在工程目录和实际目录中新建Output, User和uCOS-II文件夹，分别对应上面的几个模块，其中Output用来作为工程的输出，在其中建立两个List和Obj两个文件夹，User下用户程序，User下图的BSP模块为官方的板级支持文件，这里不需要，uCOS-II下建立两个目录Src和Ports目录，分别和源代码对应。</p>
<p><img src="/images/ucos-stm32/relationship.png" alt=""></p>
<p>然后在工程的Options的Output下，Select Foldeer for Objects，选择 Output目录下的Obj文件夹，并且同时勾选Create HEX File，Listing目录下Select Folder for Listings选择Output目录下的List文件夹。</p>
<p><img src="/images/ucos-stm32/proj_struct.png" alt=""></p>
<p>在工程上右击Manage Project Items，添加几个和工程目录中相同的Group。</p>
<p>将Micrium\Software\uCOS-II\Ports\ARM-Cortex-M3\Generic\RealView这个文件夹中的内容拷贝到uCOS-II\uCOS-Port目录, uCOS-II\Source这个文件夹中的内容拷贝到uCOS-II \uCOS-Src目录，然后分别将其加入工程中的对应的Group中。为了uCOS的源代码被误改，可以将uCOS的Src目录下的文件设置成只读。</p>
<p>将Micrium\Software\EvalBoards\ST\STM3210B-EVAL\RVMDK\OS-Probe目录下的app_cfg.h，os_cfg.h和includes.h文件拷贝到User目录下，加入对应Group中，并且在User中添加入一个应用程序文件app.c。最终代码结构可见上图。</p>
<p>为了所有的能够直接include，将图中以下的目录添加到Options的C/C++标签下面的Include Paths中，并在Define中加上USE_STDPERIPH_DRIVER。</p>
<p><img src="/images/ucos-stm32/preprocessor_sym.png" alt=""></p>
<p>修改os_cfg.h文件，#define OS_APP_HOOKS_EN 1为0，禁用钩子函数。</p>
<p>编译之后会提示os_cpu_c.c文件中OS_CPU_SysTickClkFreq函数没有定义，这里可以之间将其改正72MHZ（Cortex-M3），当然如果为了更好的适配性，可以将其改成system_stm32f10x.c文件下的一个变量SystemCoreClock。</p>
<p><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cnts = <span class="number">72000000</span> / OS_TICKS_PER_SEC</div></pre></td></tr></table></figure></p>
<p>重新编译，发现includes.h中很多文件不存在，直接将其注释掉即可。</p>
<p><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// #include &lt;cpu.h&gt;</span></div><div class="line"><span class="comment">// #include &lt;lib_def.h&gt;</span></div><div class="line"><span class="comment">// #include &lt;lib_mem.h&gt;</span></div><div class="line"><span class="comment">// #include &lt;lib_str.h&gt;</span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stm32f10x_conf.h&gt;</span></span></div><div class="line"><span class="comment">// #include &lt;stm32f10x_lib.h&gt;</span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;app_cfg.h&gt;</span></span></div><div class="line"><span class="comment">// #include &lt;lcd.h&gt;</span></div><div class="line"><span class="comment">// #include &lt;bsp.h&gt;</span></div><div class="line"></div><div class="line"><span class="comment">// #if (APP_OS_PROBE_EN == DEF_ENABLED)</span></div><div class="line"><span class="comment">// #include &lt;os_probe.h&gt;</span></div><div class="line"><span class="comment">// #endif</span></div><div class="line"></div><div class="line"><span class="comment">// #if (APP_PROBE_COM_EN == DEF_ENABLED)</span></div><div class="line"><span class="comment">// #include &lt;probe_com.h&gt;</span></div><div class="line"></div><div class="line"><span class="comment">// #if (PROBE_COM_METHOD_RS232 == DEF_ENABLED)</span></div><div class="line"><span class="comment">// #include &lt;probe_rs232.h&gt;</span></div></pre></td></tr></table></figure></p>
<p>上面只是一些简单的文件的复制，而要将ucos移植到stm32还需要使他们建立联系。uCOS-II的核心就是任务调度，其必须使用STM32的一个PendSV这个中断，其实这个就是小作业中做过的Cortex-M3的uCOS的任务切换函数。还有就是uCOS-II需要一个基准时间，其使用STM32中的一个专为操作系统设置的定时器SysTick。比较简单的解决方案是，在启动文件startup_stm32f10x_md.s中将所有的PendSV_Handler全部替换成为OS_CPU_PendSVHandler, SysTick_Handler 替换成OS_CPU_SysTickHandler，每个各有三处。也可以采用网上说的在外面实现这两个函数。</p>
<p>这样就完成了uCOS到STM32的整个移植过程。</p>
<h2>uC/OS对GPIO的访问</h2>
<p>对于GPIO的访问，这里采用了点亮LED灯的方式进行实现。</p>
<p>在app.c中写入一些的代码，其新建了两个任务，分别对应用来点亮两个LED灯。系统首先进行初始化，然后创建两个任务。</p>
<p><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"includes.h"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"ucos_ii.h"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> LED0STKSIZE 1000</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> LED1STKSIZE 1000</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">LED_GPIO_Init</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">    GPIO_InitTypeDef GPIO_InitStruct;</div><div class="line">    RCC_DeInit();</div><div class="line">    RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA, ENABLE);</div><div class="line">    GPIO_InitStruct.GPIO_Pin = GPIO_Pin_9 | GPIO_Pin_10;    </div><div class="line">    GPIO_InitStruct.GPIO_Mode = GPIO_Mode_Out_PP;</div><div class="line">    GPIO_InitStruct.GPIO_Speed = GPIO_Speed_2MHz;</div><div class="line">    GPIO_Init(GPIOA, &amp;GPIO_InitStruct);</div><div class="line">&#125;    </div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Task_LED0</span><span class="params">(<span class="keyword">void</span> *p_arg)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</div><div class="line">    &#123;</div><div class="line">        GPIO_SetBits(GPIOA, GPIO_Pin_9);    <span class="comment">//on</span></div><div class="line">        OSTimeDly(<span class="number">50</span>);                    <span class="comment">//half second</span></div><div class="line">        GPIO_ResetBits(GPIOA, GPIO_Pin_9);    <span class="comment">//off</span></div><div class="line">        OSTimeDly(<span class="number">50</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Task_LED1</span><span class="params">(<span class="keyword">void</span> *p_arg)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</div><div class="line">    &#123;</div><div class="line">        GPIO_SetBits(GPIOA, GPIO_Pin_10);    <span class="comment">//on</span></div><div class="line">        OSTimeDly(<span class="number">100</span>);    <span class="comment">//one second</span></div><div class="line">        GPIO_ResetBits(GPIOA, GPIO_Pin_10);    <span class="comment">//off</span></div><div class="line">        OSTimeDly(<span class="number">100</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">OS_STK LED0TaskStk[LED0STKSIZE];</div><div class="line">OS_STK LED1TaskStk[LED1STKSIZE];</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    LED_GPIO_Init();    <span class="comment">//initialize the gpio</span></div><div class="line">    OSInit();                    <span class="comment">//initialize the os</span></div><div class="line">    OS_CPU_SysTickInit();    <span class="comment">//initialze the system clock</span></div><div class="line">    <span class="comment">//create two task LED0 and LED1</span></div><div class="line">    OSTaskCreate(Task_LED0, (<span class="keyword">void</span> *)<span class="number">0</span>, &amp;LED0TaskStk[LED0STKSIZE - <span class="number">1</span>], <span class="number">5</span>);</div><div class="line">    OSTaskCreate(Task_LED1, (<span class="keyword">void</span> *)<span class="number">0</span>, &amp;LED1TaskStk[LED1STKSIZE - <span class="number">1</span>], <span class="number">6</span>);</div><div class="line">    OSStart();    <span class="comment">//start the os</span></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>将LED等连接到好之后，下载观察到两盏小灯闪烁</p>
<p><img src="/images/ucos-stm32/led.png" alt=""></p>
<h2>七段数码管的显示</h2>
<p><img src="/images/ucos-stm32/7seg-led-pin.png" alt=""></p>
<p>LG3641BH的引脚图如上面两幅图所示，其中A-G分别对应一个数字的七段(A-G对应如右图所示)，DP表示小数点，D1-D4表示位选信号。</p>
<p>每次我们只需要通过位选信号来显示一个数字即可以，然后利用时分复用的原理依次快速点亮其他的数字，使得人眼看起来是同时亮起来的。</p>
<p>实验中采用了GPIO的PA0-7引脚作为七段数码端的7段以及DP，PA9-12作为四个位选信号D1-D4。</p>
<p>下面为七段数码管的显示代码，digitSel为位选设置，通过传入的一个位选信号，设置PA9-12这几个位选信号的值。digitDisp为显示信号，根据传入的一个 数字以及小数点然后设置PA0-7这几个GPIO的值。</p>
<p>TaskDisp为显示七段数码管的任务，其中不断的扫描每一位数字，使得人眼看上去是一起显示的。这里需要注意的是由于位选控制和数字显示有前后之分，因此会出现某一个变化了另一个还没有变化的情况，因此这里将时间比较长的数字显示放在前面以此缩短两个GIPO的不统一的时间。而且后面加上了一个循环7000的延时，如果采用uCOS自带的定时函数，由于其精度太低，会出现闪烁，而如果这个计数设置的过小，则会出现重影。</p>
<p>TaskInc为value的递增任务，没个1秒其增加1，而且其任务的优先级需要比TaskDisp高，否则其不会得到执行。</p>
<p><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"includes.h"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"ucos_ii.h"</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> LED0STKSIZE 1000</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> LED1STKSIZE 1000</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">GPIO_Config</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">    GPIO_InitTypeDef GPIO_InitStruct;</div><div class="line">    RCC_DeInit();</div><div class="line">    RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA, ENABLE);</div><div class="line"></div><div class="line">    <span class="comment">//digit select</span></div><div class="line">    GPIO_InitStruct.GPIO_Pin = GPIO_Pin_9 | GPIO_Pin_10 | GPIO_Pin_11 | GPIO_Pin_12;</div><div class="line">    GPIO_InitStruct.GPIO_Mode = GPIO_Mode_Out_PP;</div><div class="line">    GPIO_InitStruct.GPIO_Speed = GPIO_Speed_2MHz;</div><div class="line">    GPIO_Init(GPIOA, &amp;GPIO_InitStruct);</div><div class="line"></div><div class="line">    <span class="comment">//7-segment and one point</span></div><div class="line">    GPIO_InitStruct.GPIO_Pin = GPIO_Pin_0 |</div><div class="line">                                                         GPIO_Pin_1 |</div><div class="line">                                                       GPIO_Pin_2 |</div><div class="line">                                                         GPIO_Pin_3 |</div><div class="line">                                                         GPIO_Pin_4 |</div><div class="line">                                                       GPIO_Pin_5 |</div><div class="line">                                                       GPIO_Pin_6 |</div><div class="line">                                                       GPIO_Pin_7 ;</div><div class="line"></div><div class="line">    GPIO_Init(GPIOA, &amp;GPIO_InitStruct);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">digitSel</span><span class="params">(<span class="keyword">int</span> sel)</span></span></div><div class="line">&#123;</div><div class="line">        <span class="keyword">uint16_t</span> pinSel[] = &#123;GPIO_Pin_9, GPIO_Pin_10, GPIO_Pin_11, GPIO_Pin_12&#125;;</div><div class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span>(;i&lt;<span class="number">4</span>;++i)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">if</span>(sel == i)</div><div class="line">                GPIO_SetBits(GPIOA, pinSel[i]);</div><div class="line">            <span class="keyword">else</span></div><div class="line">                GPIO_ResetBits(GPIOA, pinSel[i]);</div><div class="line">        &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">digitDisp</span><span class="params">(<span class="keyword">int</span> digit, <span class="keyword">int</span> point)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">int</span> node, i;</div><div class="line">    <span class="keyword">uint16_t</span> pinSel[] = &#123;GPIO_Pin_0, GPIO_Pin_1, GPIO_Pin_2, GPIO_Pin_3,GPIO_Pin_4, GPIO_Pin_5, GPIO_Pin_6, GPIO_Pin_7&#125;;</div><div class="line">    <span class="keyword">int</span> sel = <span class="number">1</span>&lt;&lt; <span class="number">7</span>;</div><div class="line"></div><div class="line">    <span class="keyword">switch</span> (digit)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">case</span> <span class="number">0</span> : node = <span class="number">0xFC</span>; <span class="keyword">break</span>; <span class="comment">// 11111100</span></div><div class="line">    <span class="keyword">case</span> <span class="number">1</span> : node = <span class="number">0x60</span>; <span class="keyword">break</span>; <span class="comment">// 01100000</span></div><div class="line">    <span class="keyword">case</span> <span class="number">2</span> : node = <span class="number">0xDA</span>; <span class="keyword">break</span>; <span class="comment">// 11011010</span></div><div class="line">    <span class="keyword">case</span> <span class="number">3</span> : node = <span class="number">0xF2</span>; <span class="keyword">break</span>; <span class="comment">// 11110010</span></div><div class="line">    <span class="keyword">case</span> <span class="number">4</span> : node = <span class="number">0x66</span>; <span class="keyword">break</span>; <span class="comment">// 01100110</span></div><div class="line">    <span class="keyword">case</span> <span class="number">5</span> : node = <span class="number">0xB6</span>; <span class="keyword">break</span>; <span class="comment">// 10110110</span></div><div class="line">    <span class="keyword">case</span> <span class="number">6</span> : node = <span class="number">0xBE</span>; <span class="keyword">break</span>; <span class="comment">// 10111110</span></div><div class="line">    <span class="keyword">case</span> <span class="number">7</span> : node = <span class="number">0xE0</span>; <span class="keyword">break</span>; <span class="comment">// 11100000</span></div><div class="line">    <span class="keyword">case</span> <span class="number">8</span> : node = <span class="number">0xFE</span>; <span class="keyword">break</span>; <span class="comment">// 11111110</span></div><div class="line">    <span class="keyword">case</span> <span class="number">9</span> : node = <span class="number">0xF6</span>; <span class="keyword">break</span>; <span class="comment">// 11110110</span></div><div class="line">    <span class="keyword">default</span>: node = <span class="number">0x9E</span>; <span class="keyword">break</span>; <span class="comment">// 10011110 error and display E to represent error</span></div><div class="line">   &#125;</div><div class="line">     node |= (point != <span class="number">0</span>);</div><div class="line"></div><div class="line">     <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">8</span>;i++)</div><div class="line">     &#123;</div><div class="line">        <span class="keyword">if</span>((node &amp; sel) == <span class="number">0</span>)</div><div class="line">            GPIO_SetBits(GPIOA, pinSel[i]);</div><div class="line">        <span class="keyword">else</span></div><div class="line">            GPIO_ResetBits(GPIOA, pinSel[i]);</div><div class="line"></div><div class="line">        sel &gt;&gt;= <span class="number">1</span>;</div><div class="line">     &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">int</span> value = <span class="number">0</span>;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">TaskDisp</span><span class="params">(<span class="keyword">void</span> *p_arg)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">int</span> i, base, cnt = <span class="number">7000</span>;</div><div class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</div><div class="line">    &#123;</div><div class="line">        base = <span class="number">1000</span>;</div><div class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">4</span>;i++)</div><div class="line">        &#123;</div><div class="line">            digitDisp((value/base)%<span class="number">10</span>, <span class="number">0</span>);</div><div class="line">            digitSel(i);</div><div class="line">            base /= <span class="number">10</span>;</div><div class="line">            <span class="keyword">while</span>(cnt--);</div><div class="line">            cnt = <span class="number">8000</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">TaskInc</span><span class="params">(<span class="keyword">void</span> *p_arg)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</div><div class="line">    &#123;</div><div class="line">        value++;</div><div class="line">        value %= <span class="number">10000</span>;</div><div class="line">        OSTimeDly(<span class="number">100</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">OS_STK TaskStk1[LED0STKSIZE];</div><div class="line">OS_STK TaskStk2[LED1STKSIZE];</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    GPIO_Config();    <span class="comment">//initialize the gpio</span></div><div class="line"></div><div class="line">    OSInit();                    <span class="comment">//initialize the os</span></div><div class="line">    OS_CPU_SysTickInit();    <span class="comment">//initialze the system clock</span></div><div class="line"></div><div class="line">    <span class="comment">//create two task LED0 and LED</span></div><div class="line">    OSTaskCreate(TaskDisp, (<span class="keyword">void</span> *)<span class="number">0</span>, &amp;TaskStk1[LED0STKSIZE - <span class="number">1</span>], <span class="number">5</span>);</div><div class="line">    OSTaskCreate(TaskInc, (<span class="keyword">void</span> *)<span class="number">0</span>, &amp;TaskStk2[LED0STKSIZE - <span class="number">1</span>], <span class="number">4</span>);</div><div class="line">    OSStart();    <span class="comment">//start the os</span></div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>运行之后download观看显示结果（显示的测试显示的1234的结果）</p>
<p><img src="/images/ucos-stm32/7seg-display.jpg" alt=""></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="www.wangkejie.me/2016/04/17/stm32-start-cube/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kejie Wang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kejie Wang">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/04/17/stm32-start-cube/" itemprop="url">STM32上电启动以及Cube库的程序编写</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-04-17T11:29:00+08:00">
                2016-04-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/EmbededSystem/" itemprop="url" rel="index">
                    <span itemprop="name">EmbededSystem</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/04/17/stm32-start-cube/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count fb-comments-count" data-href="www.wangkejie.me/2016/04/17/stm32-start-cube/" itemprop="commentCount">0</span> comments
                </a>
              </span>
            
          

          
          
             <span id="/2016/04/17/stm32-start-cube/" class="leancloud_visitors" data-flag-title="STM32上电启动以及Cube库的程序编写">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Visitors </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1>器材</h1>
<h2>硬件</h2>
<ul>
<li>STM32F103核心板板一块</li>
<li>microUSB线一根(供电)</li>
<li>STLink板或USB串口板一块</li>
</ul>
<h2>软件</h2>
<ul>
<li>交叉编译软件。</li>
<li>STM32CubeMX, Keil</li>
<li>串口软件Putty
&lt;!-- more --&gt;</li>
</ul>
<h1>连接示意图</h1>
<p><img src="/images/stm32-start-cube/conn.png" alt=""></p>
<h1>实验步骤</h1>
<h2>串口输出Hello</h2>
<h3>STM32CubeMX</h3>
<p>首先安装STM32CubeMX，并且下载相应的STM32的库，由于实验中采用的是STM32F103C8，因此这里下载STM32F1的库，如下图所示<img src="/images/stm32-start-cube/stm32-lib.png" alt=""></p>
<p>然后新建一个工程，选择正确的板子型号（STM32F103C8Tx），定义引脚，这里定义PA.09为USART1_TX，PA.10为USART1_RX，并且设定模式为异步，Hardware Flow Control为Disable<img src="/images/stm32-start-cube/pin-def.png" alt=""></p>
<h3>Keil</h3>
<p>再安装Keil软件，用来生成hex文件并且用其通过ST-LINK来下载到板子上运行。初次安装的时候需要下载相应的STM32设备包。</p>
<p>打开main.c中可以看到串口的初始化函数，按照要求设定串口的波特率为9600，数据的宽度为8，停止位为一位，没有检验位，然后用HAL_UART_Init函数初始化。</p>
<p><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* USART1 init function */</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">MX_USART1_UART_Init</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">  huart1.Instance = USART1;</div><div class="line">  huart1.Init.BaudRate = <span class="number">9600</span>;</div><div class="line">  huart1.Init.WordLength = UART_WORDLENGTH_8B;</div><div class="line">  huart1.Init.StopBits = UART_STOPBITS_1;</div><div class="line">  huart1.Init.Parity = UART_PARITY_NONE;</div><div class="line">  huart1.Init.Mode = UART_MODE_TX_RX;</div><div class="line">  huart1.Init.HwFlowCtl = UART_HWCONTROL_NONE;</div><div class="line">  huart1.Init.OverSampling = UART_OVERSAMPLING_16;</div><div class="line">  HAL_UART_Init(&amp;huart1);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这样子即可以采用HAL_UART_Transmit和HAL_UART_Receive两个函数进行串口的收发了。但是为了简单起见，这里重写了printf函数，以便可以用printf进行写入串口。重写int __io_putchar(int ch)和int fputc(int ch, FILE *f)两个函数</p>
<p><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __GNUC__</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> PUTCHAR_PROTOTYPE int __io_putchar(int ch)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> PUTCHAR_PROTOTYPE int fputc(int ch, FILE *f)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* __GNUC__ */</span></span></div><div class="line">PUTCHAR_PROTOTYPE</div><div class="line">&#123;</div><div class="line"></div><div class="line">  HAL_UART_Transmit(&amp;huart1, (<span class="keyword">uint8_t</span> *)&amp;ch, <span class="number">1</span>, <span class="number">0xFFFF</span>);</div><div class="line">  <span class="keyword">return</span> ch;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这样即可以采用 printf 函数进行串口发送数据了，在 main 中加入一行printf(“Hello”);先串口写入 Hello 的函数。</p>
<h3>ST-LINK 下载</h3>
<p>开始配置 Keil，打开设置后首先选定设备为 STM32F103C8，然后在Output中勾选Create HEX File选项。然后在解散ST-LINk之后可以在Debug选项中可以看到ST-LINK的调试器，并且打开设备可以看到相关的设备名字说明ST-LINK连接成功。在连接ST-LINK之前需要安装ST-LINK的驱动，然后在设备管理器中就可以看到已经成功挂载的设备。</p>
<p>在以上设置完毕以后，编译源代码，然后选择Flash-&gt; download就可以下载了。</p>
<h3>Putty</h3>
<p>后采用串口软件Putty读取串口上的数据，设置串口的属性如下:<img src="/images/stm32-start-cube/putty-setting.png" alt=""></p>
<p>打开串口，并且按下STM32上面的reset键就可以在串口上看到Hello字样</p>
<h2>开关检测</h2>
<p>在STM32CubeMX中加入两个GPIO输入PA11和PA12，设定其为GPIO_Input</p>
<p>然后在Keil中修改GPIO的初始化函数如下，设定PA11的方式为上拉输入，PA12为下降沿中断触发，初始化两个GPIO。</p>
<p><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">MX_GPIO_Init</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">  GPIO_InitTypeDef GPIO_InitStruct;</div><div class="line"></div><div class="line">  <span class="comment">/* GPIO Ports Clock Enable */</span></div><div class="line">  __HAL_RCC_GPIOA_CLK_ENABLE();</div><div class="line"></div><div class="line">  <span class="comment">/*Configure GPIO pins : PA11 PA12 */</span></div><div class="line">  GPIO_InitStruct.Pin = GPIO_PIN_11;   </div><div class="line">    GPIO_InitStruct.Mode = GPIO_MODE_INPUT;   </div><div class="line">    GPIO_InitStruct.Pull = GPIO_PULLUP;   </div><div class="line">    GPIO_InitStruct.Speed = GPIO_SPEED_LOW;   </div><div class="line">    HAL_GPIO_Init(GPIOA, &amp;GPIO_InitStruct);   </div><div class="line">    GPIO_InitStruct.Pin = GPIO_PIN_12;   </div><div class="line">    GPIO_InitStruct.Mode = GPIO_MODE_IT_FALLING;   </div><div class="line">    GPIO_InitStruct.Pull = GPIO_PULLUP;   </div><div class="line">    GPIO_InitStruct.Speed = GPIO_SPEED_LOW;   </div><div class="line">    HAL_GPIO_Init(GPIOA, &amp;GPIO_InitStruct);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在main函数中加入GPIO的初始化函数，并且加入对于PA11的按下的检测函数，注意需要加上防抖动处理，否则会按下输出很多的Pressed</p>
<p><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">while</span> (<span class="number">1</span>)</div><div class="line">&#123;</div><div class="line"> <span class="comment">/* USER CODE END WHILE */</span></div><div class="line"></div><div class="line"> <span class="comment">/* USER CODE BEGIN 3 */</span></div><div class="line">        <span class="keyword">if</span>(HAL_GPIO_ReadPin(GPIOA, GPIO_PIN_11) == <span class="number">0</span>)</div><div class="line">        &#123;</div><div class="line">                HAL_Delay(<span class="number">100</span>);        <span class="comment">//anti-jitter</span></div><div class="line">                <span class="keyword">if</span>(HAL_GPIO_ReadPin(GPIOA, GPIO_PIN_11) == <span class="number">0</span>)</div><div class="line">                &#123;</div><div class="line">                    <span class="built_in">printf</span>(<span class="string">"Pressed\r\n"</span>);</div><div class="line">                &#125;</div><div class="line">        &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>重新build工程，然后下载到板子上通过串口查看结果</p>
<h2>PA12<strong>中断响应</strong></h2>
<p>在上面PA11的基础上进行修改，因此这里不需要添加引脚，不用STM32CubeMX。</p>
<p>首先配置PA12为下降边沿触发，在GPIO的初始化函数中如下设置</p>
<p><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">GPIO_InitStruct.Pin = GPIO_PIN_12;   </div><div class="line">GPIO_InitStruct.Mode = GPIO_MODE_IT_FALLING;   </div><div class="line">GPIO_InitStruct.Pull = GPIO_PULLUP;   </div><div class="line">GPIO_InitStruct.Speed = GPIO_SPEED_LOW;   </div><div class="line">HAL_GPIO_Init(GPIOA, &amp;GPIO_InitStruct);</div></pre></td></tr></table></figure></p>
<p>设置中断的优先级，enable中断向量 表处理，在main函数中添加以下代码</p>
<p><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">HAL_NVIC_SetPriority(EXTI15_10_IRQn, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">HAL_NVIC_EnableIRQ(EXTI15_10_IRQn);</div></pre></td></tr></table></figure></p>
<p>当出现中断的时候，由于设定的引脚为PA12，因此当出现中断的时候，STM32会调用EXTI15_10_IRQHandler这个中断服务程序进行处理，我们在stm32f1xx_it.c中实现它，并在里面调用HAL_GPIO_EXTI_IRQHandler函数。由于上述函数会判断中断标志位并且调用HAL_GPIO_EXTI_Callback函数，因此我们将中断处理程序放在了HAL_GPIO_EXTI_Callback函数中进行实现</p>
<p><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">EXTI15_10_IRQHandler</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">    HAL_GPIO_EXTI_IRQHandler(GPIO_PIN_12);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">HAL_GPIO_EXTI_Callback</span><span class="params">(<span class="keyword">uint16_t</span> GPIO_Pin)</span></span></div><div class="line">&#123;</div><div class="line">    flag = <span class="number">1</span>;</div><div class="line">    counter = counter + <span class="number">1</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>对于全局变量的定义，我们在main.c中定影了两个全局变量flag和counter，然后在stm32f1xx_it.c中用extern关键词声明这两个变量以此达到两个c文件共享全局变量的效果。</p>
<p>然后在main的主循环中判断标志flag，如果其为1，则输出counter值，并且消除标志位。这里为了输出整形变量的值，我写了一个从unsigned int到字符串的函数，以便采用printf进行输出。</p>
<p><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">while</span> (<span class="number">1</span>)</div><div class="line">  &#123;</div><div class="line">  <span class="comment">/* USER CODE END WHILE */</span></div><div class="line">  <span class="comment">/* USER CODE BEGIN 3 */</span></div><div class="line">        <span class="keyword">if</span>(HAL_GPIO_ReadPin(GPIOA, GPIO_PIN_11) == <span class="number">0</span>)</div><div class="line">        &#123;</div><div class="line">            HAL_Delay(<span class="number">100</span>);        <span class="comment">//anti-jitter</span></div><div class="line">            <span class="keyword">if</span>(HAL_GPIO_ReadPin(GPIOA, GPIO_PIN_11) == <span class="number">0</span>)</div><div class="line">            &#123;</div><div class="line">                    <span class="built_in">printf</span>(<span class="string">"Pressed\r\n"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span>(flag)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">char</span> s[<span class="number">33</span>];</div><div class="line">            toString(counter, s);</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"%s\r\n"</span>, s);</div><div class="line">            flag = <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">  &#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">*transform a integer into a string</div><div class="line">*@num: The input number</div><div class="line">*@s: The string after transforming</div><div class="line">*@return void</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">toString</span><span class="params">(<span class="keyword">int</span> num, <span class="keyword">char</span> s[])</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">int</span> len = <span class="number">0</span>, tmp = num;</div><div class="line"><span class="keyword">if</span>(tmp==<span class="number">0</span>)</div><div class="line">    len=<span class="number">1</span>;</div><div class="line">    <span class="keyword">while</span>(tmp != <span class="number">0</span>)</div><div class="line">    &#123;</div><div class="line">        len++;</div><div class="line">        tmp /= <span class="number">10</span>;</div><div class="line">    &#125;</div><div class="line">    s[len--] = <span class="string">'\0'</span>;</div><div class="line">    <span class="keyword">while</span>(num != <span class="number">0</span>)</div><div class="line">    &#123;</div><div class="line">        s[len--] = (num%<span class="number">10</span>) + <span class="string">'0'</span>;</div><div class="line">        num /= <span class="number">10</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>重新编译代码，下板执行。通过下图可以看到，每次按下按钮会输出一个递增的数字，说明程序运行正确。</p>
<h2>时钟中断</h2>
<p>首先采用STM32CubeMX启用TIM3，并且采用内部时钟</p>
<p>然后生成代码，用Keil打开工程。</p>
<p>采用内部时钟，其频率为8MHz，配置时钟向上计数，计数到199，Prescaler的分频范围为0-65536，因此在这里设置为8000，，8MHz/8000 = 1000Hz = 1ms。</p>
<p>修改MX_TIM3_Init函数体如下，分别设置时钟为TIM3，Prescaler为8000，计数模式为向上计数，周期为199，时钟为内部时钟以及复位模式。然后设置中断的优先级，enable中断向量表处理。最后初始化定时器。</p>
<p><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* TIM3 init function */</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">MX_TIM3_Init</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">  TIM_ClockConfigTypeDef sClockSourceConfig;</div><div class="line">  TIM_MasterConfigTypeDef sMasterConfig;</div><div class="line"></div><div class="line">    TIM_Handle.Instance = TIM3;   </div><div class="line">    TIM_Handle.Init.Prescaler = <span class="number">8000</span>;   </div><div class="line">    TIM_Handle.Init.CounterMode = TIM_COUNTERMODE_UP;   </div><div class="line">    TIM_Handle.Init.Period = <span class="number">199</span>;</div><div class="line"></div><div class="line">  sClockSourceConfig.ClockSource = TIM_CLOCKSOURCE_INTERNAL;</div><div class="line"> <span class="comment">// HAL_TIM_ConfigClockSource(&amp;TIM_Handle, &amp;sClockSourceConfig);</span></div><div class="line"></div><div class="line">  sMasterConfig.MasterOutputTrigger = TIM_TRGO_RESET;</div><div class="line">    HAL_NVIC_SetPriority(TIM3_IRQn, <span class="number">0</span>, <span class="number">0</span>);   </div><div class="line">    HAL_NVIC_EnableIRQ(TIM3_IRQn);</div><div class="line"></div><div class="line">  HAL_TIM_Base_Init(&amp;TIM_Handle);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在stm32f1xx_hal_msp.c中的HAL_TIM_Base_MspInit中enable定时器时钟，在HAL_TIM_Base_MspDeInit中disable定时器时钟（如果采用STM32CubeMX生成，其会自动生成该代码，否则就需要自己添加）。</p>
<p>由于定时器中断调用TIM3_IRQHandler函数，因此我们在stm32f1xx_it.c中编写中断服务程序TIM3_IRQHandler函数。由于在其中要用HAL_TIM_IRQHandler</p>
<p>(&amp;TIM_Handle),因此在stm32f1xx_it.c采用extern申明TIM_Handle。由于该服务程序会调用HAL_TIM_PeriodElapsedCallback回调函数，因此在其中加入中断处理的程序。在这里我加的是一个将标志位置位，然后将一个全局变量加上10的一个操作。</p>
<p><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">TIM3_IRQHandler</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">    HAL_TIM_IRQHandler(&amp;TIM_Handle);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">HAL_TIM_PeriodElapsedCallback</span><span class="params">(TIM_HandleTypeDef *htim)</span></span></div><div class="line">&#123;</div><div class="line">    timeFlag = <span class="number">1</span>;</div><div class="line">    counter += <span class="number">10</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后在main中HAL_TIM_Base_Start_IT(&amp;TIM_Handle)启动定时器，在主循环中输出counter的值来检验定时中断。</p>
<p><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">while</span> (<span class="number">1</span>)</div><div class="line">&#123;</div><div class="line"><span class="comment">/* USER CODE END WHILE */</span></div><div class="line"></div><div class="line"><span class="comment">/* USER CODE BEGIN 3 */</span></div><div class="line">      <span class="comment">//time interrupt</span></div><div class="line">      <span class="keyword">if</span>(timeFlag)</div><div class="line">      &#123;</div><div class="line">          <span class="keyword">char</span> s[<span class="number">33</span>];</div><div class="line">          toString(counter, s);</div><div class="line">          <span class="built_in">printf</span>(<span class="string">"%s\r\n"</span>, s);</div><div class="line">          timeFlag = <span class="number">0</span>;</div><div class="line">      &#125;</div><div class="line">      <span class="comment">/* USER CODE END 3 */</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>重新编译代码，将其载入板子运行，通过串口观看结果。通过下图可以看到，串口上不断输出了以10递增的一些列数字，说明定时中断正常工作。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="www.wangkejie.me/2016/03/09/rasp-zjuvpn/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kejie Wang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kejie Wang">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/03/09/rasp-zjuvpn/" itemprop="url">树莓派（Raspberry Pi）-浙大(ZJU)VPN连接</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-03-09T23:32:00+08:00">
                2016-03-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/EmbededSystem/" itemprop="url" rel="index">
                    <span itemprop="name">EmbededSystem</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/03/09/rasp-zjuvpn/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count fb-comments-count" data-href="www.wangkejie.me/2016/03/09/rasp-zjuvpn/" itemprop="commentCount">0</span> comments
                </a>
              </span>
            
          

          
          
             <span id="/2016/03/09/rasp-zjuvpn/" class="leancloud_visitors" data-flag-title="树莓派（Raspberry Pi）-浙大(ZJU)VPN连接">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Visitors </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>连接上树莓派后，系统自动默认进入的是命令行模式，默认的用户名为：pi，密码：raspberry。
可以在刚刚启动的界面中进行修改为图形界面模式，然后sudo reboot后就进入可桌面模式。由于树莓派默认的为UK标准的键盘，会发现和外接键盘不匹配，可以将其修改成US的键盘。
&lt;!-- more --&gt;</p>
<h1>连接内网</h1>
<p>关于树莓派的VPN联网，现在玉泉的有线需要申请固定的ip的，网络ip地址申请完成后。
首先需要将树莓派的网卡的Mac地址改成申请的地址，或者使用其地址申请（ifconfig命令查看）
修改的方法为如下图所示
<img src="/images/rasp-zju-vpn/addr-change.png" alt="">
然后设置VPN的一些参数：
设置ip地址
将网线插上后，执行下列命令
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> sudo ip addr flush dev eth0</div><div class="line"><span class="meta">$</span> sudo ip addr add dev eth0 $I/$U</div></pre></td></tr></table></figure></p>
<p>其中$I用你的ip静态ip地址代替，$U用你的子网掩码的前导1的个数代替（如果数不清楚的话，把你的子网掩码转换成二进制数，然后从最高位开始数1的个数）
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> sudo ip route replace default via $D</div></pre></td></tr></table></figure></p>
<p>$D用你的默认网关代替
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> sudo nano /etc/resolv.conf</div><div class="line"><span class="meta">$</span> nameserver $DNS</div></pre></td></tr></table></figure></p>
<p>$DNS用DNS服务器代替
设置完成之后就可以尝试ping下cc98
<img src="/images/rasp-zju-vpn/ping-cc98.png" alt=""></p>
<h1>连接外网</h1>
<p>上面已经将树莓派连接上了内网，如果需要访问外网需要配置vpn。下载安装包，使用U盘将其拷贝到Raspberry Pi中去，解压后执行以下的命令
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> sudo dpkg –i libpcap0.8_1.3.0-1_armhf.deb</div><div class="line"><span class="meta">$</span> sudo dpkg –i ppp_2.4.5-5.1_armhf.deb</div><div class="line"><span class="meta">$</span> sudo dpkg –i xl2tpd_1.3.1+dfsg-1_armhf.deb</div><div class="line"><span class="meta">$</span> tar –zxvf zjuvpn-8.2.tar.gz –C /</div><div class="line"><span class="meta">$</span> sudo zjuvpn -c</div></pre></td></tr></table></figure></p>
<p>然后输入用户名和密码就可以上网了，ping下度娘测试下外网有没有用吧</p>
<p>对于/ect/resolv.conf文件会被重写的问题可以执行以下命令
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> aptitude purge dhcpcd5</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/avatar.jpg"
               alt="Kejie Wang" />
          <p class="site-author-name" itemprop="name">Kejie Wang</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">8</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">2</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">12</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/Kejie-Wang" target="_blank" title="Github">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  Github
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Kejie Wang</span>
</div>



        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.1"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  





  






  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("nF4mgzkDRznFy6gtW0oCcxul-gzGzoHsz", "1iG9seaYADWImk07bhvTuYJU");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script><!-- hexo-inject:begin --><!-- hexo-inject:end -->



  

  

  

  

</body>
</html>
